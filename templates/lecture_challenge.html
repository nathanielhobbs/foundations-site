{% extends 'base.html' %}

{% block title %}Lecture Challenge – {{ ch.title }}{% endblock %}

{% block extra_head %}
{{ super() }}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>

<!-- Light + Dark themes (we switch in JS) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">

<style>
  /* Theme-aware colors for the output pane and message types */
  :root {
    --panel-bg: #f6f8fa;
    --panel-text: #24292f;
    --panel-border: #d0d7de;
    --stdout: #0b7a0b;
    --stderr: #b00020;
    --system: #6b7280;
  }
  [data-theme="dark"] {
    --panel-bg: #0b1020;
    --panel-text: #e8e8f2;
    --panel-border: #30363d;
    --stdout: #a6e22e;
    --stderr: #ff6b6b;
    --system: #9ca3af;
  }

  .row {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-block: .75rem;
  }
  /* CodeMirror container */
  .CodeMirror {
    flex: 1;
    border: 1px solid var(--panel-border);
    border-radius: 12px;
    font-size: 14px;
    height: 400px !important;   /* start tall */
    min-height: 400px !important;
    resize: both;               /* allow drag-resize */
    overflow: auto;             /* required for resize to work */
    background: var(--panel-bg);
    color: var(--panel-text);
  }
  .controls {
    display: flex;
    flex-direction: column;
    gap: .5rem;
    min-width: 140px;
  }
  .output-box {
    border: 1px solid var(--panel-border);
    border-radius: 12px;
    padding: 12px;
    min-height: 200px;
    background: var(--panel-bg);
    color: var(--panel-text);
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 14px;
    overflow: auto;
    resize: both;               /* allow drag-resize */
    white-space: pre-wrap; /* preserve \n as line breaks */
  }
  .stdout { color: var(--stdout); }
  .stderr { color: var(--stderr); }
  .system { color: var(--system); }
  button {
    padding: .6rem 1rem;
    border: 0;
    border-radius: 999px;
    cursor: pointer;
  }
  .primary { background: #2151ff; color:#fff; }
  .ghost { background: #eee; }
  .muted { color:#666; font-size:.9rem; }
  .panel { background: var(--bg); color: var(--text); border:1px solid rgba(0,0,0,.12); border-radius: 12px; }
  #output { margin:0; padding:.75rem; white-space: pre-wrap; min-height:120px; border:1px solid rgba(0,0,0,.15); border-radius: 8px; }
  .toolbar button { /* keeps your buttons visually consistent */ padding:.45rem .9rem; }
  .output-box, #output {
    box-shadow: 0 1px 2px rgba(0,0,0,.04), 0 4px 12px rgba(0,0,0,.06);
  }

  /* ----- Dark mode improvements ----- */
:root[data-theme="dark"] {
  --bg-1: #0d1117;      /* code/output bg */
  --bg-2: #161b22;      /* dropdown bg */
  --bd-1: #30363d;      /* borders */
  --fg-1: #c9d1d9;      /* text */
  --muted: #8b949e;     /* muted text */
}

/* Editor container + output */
:root[data-theme="dark"] .CodeMirror {
  background: var(--bg-1) !important;
  color: var(--fg-1);
  border-color: var(--bd-1);
}
:root[data-theme="dark"] .cm-s-material.CodeMirror { background: var(--bg-1) !important; }
:root[data-theme="dark"] #output {
  background: var(--bg-1);
  color: var(--fg-1);
  border-color: var(--bd-1);
}

/* Accepted Solutions dropdown */
:root[data-theme="dark"] #replaysMenu {
  background: var(--bg-2);
  border-color: var(--bd-1);
  color: var(--fg-1);
}
:root[data-theme="dark"] #replaysMenu .text-muted { color: var(--muted); }
/* Preview/editor gutters + numbers in dark mode */
:root[data-theme="dark"] .cm-s-material .CodeMirror-gutters {
  background: var(--bg-1);
  border-right: 1px solid var(--bd-1);
}
:root[data-theme="dark"] .cm-s-material .CodeMirror-linenumber {
  color: var(--muted);
}

/* Selection tone in dark mode (less harsh) */
:root[data-theme="dark"] .cm-s-material .CodeMirror-selected {
  background: #26364a !important;
}

/* Token colors can look dim on some screens—nudge comments/numbers */
:root[data-theme="dark"] .cm-s-material span.cm-comment   { color: #8b949e; }
:root[data-theme="dark"] .cm-s-material span.cm-number    { color: #79c0ff; }

</style>
<style>
/* Two-pane layout */
#workArea.lc-grid {
  display: grid;
  grid-template-columns: minmax(0,1fr) 420px;
  gap: 16px;
  align-items: start;
}

/* Code areas */
.CodeMirror { height: 360px; }
#rv-editor .CodeMirror { height: 260px !important; }

/* Output pane */
#output {
  height: 160px;
  overflow: auto;
  white-space: pre-wrap;
}

/* Toolbar: keep right buttons on same line */
.lc-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
.lc-toolbar-right { display: flex; gap: 8px; align-items: center; white-space: nowrap; }

/* Dropdown */
#replaysMenu { position: absolute; right: 0; top: 100%; z-index: 1000; width: 22rem;
  max-height: 60vh; overflow: auto; background: #fff; border: 1px solid #ddd; border-radius: 6px;
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
}

/* Small screens: stack */
@media (max-width: 900px) {
  #workArea.lc-grid { grid-template-columns: 1fr; }
}



/* Base palette as CSS variables (works with light/dark) */
:root {
  --ok: 22 163 74;      /* green-600 */
  --warn: 202 138 4;    /* amber-600 */
  --bad: 220 38 38;     /* red-600 */
  --fg: 17 24 39;       /* slate-900 */
  --muted: 71 85 105;   /* slate-500 */
  --card: 255 255 255;  /* white */
  --border: 226 232 240;/* slate-200 */
  --tint: 248 250 252;  /* slate-50 */
}

:root[data-theme="dark"] {
  --fg: 226 232 240;      /* slate-200 */
  --muted: 148 163 184;   /* slate-400 */
  --card: 15 23 42;       /* slate-900 */
  --border: 51 65 85;     /* slate-700 */
  --tint: 2 6 23;         /* slate-950 */
}

/* (optional) explicitly force light when data-theme="light" */
:root[data-theme="light"] {
  --fg: 17 24 39;
  --muted: 71 85 105;
  --card: 255 255 255;
  --border: 226 232 240;
  --tint: 248 250 252;
}


/* Card container */
.substatus-card{
  background: rgb(var(--card));
  border: 1px solid rgb(var(--border));
  border-radius: 14px;
  padding: 14px 16px;
  box-shadow: 0 1px 2px rgb(0 0 0 / 0.04);
  max-width: 720px;
}

/* Header */
.substatus-header{
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  justify-content: space-between;
}
.substatus-title{ font-weight: 700; color: rgb(var(--fg)); font-size: 0.95rem; }

.substatus-points{ font-weight: 700; color: rgb(var(--fg)); }

/* Status badge */
.status-badge{
  font-weight: 800;
  letter-spacing: .02em;
  border-radius: 999px;
  padding: 4px 10px;
  border: 1px solid transparent;
  font-size: 0.80rem;
}
.status-approved{
  color: rgb(var(--ok));
  background: color-mix(in srgb, rgb(var(--ok)) 16%, transparent);
  border-color: rgb(var(--ok));
}
.status-pending{
  color: rgb(var(--warn));
  background: color-mix(in srgb, rgb(var(--warn)) 16%, transparent);
  border-color: rgb(var(--warn));
}
.status-rejected{
  color: rgb(var(--bad));
  background: color-mix(in srgb, rgb(var(--bad)) 16%, transparent);
  border-color: rgb(var(--bad));
}

/* Feedback block */
.feedback-card{
  margin-top: 12px;
  border: 1px solid rgb(var(--border));
  border-left-width: 6px;
  border-radius: 12px;
  padding: 10px 12px;
  background: rgb(var(--tint));
}
.status-approved ~ .feedback-card{ border-left-color: rgb(var(--ok)); }
.status-pending  ~ .feedback-card{ border-left-color: rgb(var(--warn)); }
.status-rejected ~ .feedback-card{ border-left-color: rgb(var(--bad)); }

.feedback-label{
  font-size: .80rem; font-weight: 700; text-transform: uppercase; letter-spacing:.04em;
  color: rgb(var(--muted)); margin-bottom: 4px;
}
.feedback-body{ font-size: 1rem; line-height: 1.45; color: rgb(var(--fg)); }
.feedback-muted{ opacity: .7; font-style: italic; }

/* Meta line */
.substatus-meta{
  margin-top: 8px; font-size: .8rem; color: rgb(var(--muted));
}

</style>

{% endblock %}



{% block content %}
<div class="container">
  <h1>{{ ch.title }}</h1>
  <div id="studentCountdown" class="text-sm opacity-80 mb-2"></div>
	<script>
	(function(){
	  // server should render ch.close_at (ISO) if present
	  const closeISO = {{ (ch.close_at.isoformat() if ch.close_at else 'null')|tojson }};
	  const box = document.getElementById('studentCountdown');
	  function pad(n){ return n<10 ? '0'+n : n; }
	  function tick(){
	    if (!closeISO){ box.textContent=''; return; }
	    const end = new Date(closeISO);
	    const ms  = end - new Date();
	    if (ms <= 0){ box.textContent = 'Challenge closed'; return; }
	    const s = Math.floor(ms/1000), m = Math.floor(s/60), r = s%60;
	    box.textContent = `Time remaining: ${m}:${pad(r)}`;
	    setTimeout(tick, 250);
	  }
	  tick();
	})();
	</script>

  <article class="prompt markdown-body">{{ ch.prompt_md|safe }}</article>

  <div class="editor-wrap">
    <!--
    <div class="toolbar">
      <button id="runBtn">Run</button>
      <button id="submitBtn" ... {% if not can_submit %}disabled title="Submissions are closed for your section"{% endif %}>Submit</button>

      <span class="status" id="statusText"></span>
    </div>
    -->
    <br>
<!-- Toolbar -->
<div class="lc-toolbar mb-2">
  <!-- Left: Run / Submit -->
  <div class="flex items-center gap-2">
    <button id="runBtn" class="btn btn-primary">Run</button>
    <button id="submitBtn" class="btn btn-success" {% if not can_submit %}disabled title="Submissions are closed for your section"{% endif %}>Submit</button>
    <span id="status" class="text-sm text-muted"></span>
  </div>

  <!-- Right: Accepted Solutions dropdown + Restore (same line) -->
  <div class="lc-toolbar-right">
    <div style="position:relative">
      <button id="replaysToggle" class="btn btn-secondary">See Accepted Solutions ▾</button>
      <div id="replaysMenu" style="display:none">
        <div class="text-sm text-muted p-2">Loading…</div>
      </div>
    </div>
    <button id="restoreBtn" class="btn btn-warning" style="display:none;">Restore my Code</button>
  </div>
</div>

<!--
    <div id="studentStatus" class="panel" style="margin-top:.5rem;display:none;">
      <div class="panel-title">Submission Status</div>
      <div id="studentStatusBody" style="padding:.6rem;"></div>
    </div>
--->
    <div id="submission-status"></div>


<!-- Work area: left editor/output, right preview -->
<div id="workArea" class="lc-grid">
  <!-- LEFT -->
  <div>
    <label class="block text-sm font-semibold mb-1">Editor</label>
    <div id="editor" class="border rounded"></div>

    <label class="block text-sm font-semibold mt-3 mb-1">Output</label>
    <pre id="output" class="border rounded p-2"></pre>
  </div>

  <!-- RIGHT -->
  <aside id="replayPanel" class="border rounded p-2" style="display:none;">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-muted">
        <strong>Previewing accepted solution</strong><span id="rv-meta"></span>
      </div>
      <div class="flex items-center gap-2">
        <button id="rv-load" class="btn btn-primary btn-sm">Load into Editor</button>
        <button id="rv-close" class="btn btn-secondary btn-sm">Close</button>
      </div>
    </div>

    <label class="block text-sm font-semibold mb-1">Code (read-only)</label>
    <div id="rv-editor" class="border rounded"></div>

    <label class="block text-sm font-semibold mt-3 mb-1">Last run output</label>
    <pre id="rv-output" class="border rounded p-2" style="max-height:160px; overflow:auto; white-space:pre-wrap;"></pre>
  </aside>
</div>



	    <textarea id="code" style="display:none;"></textarea>

    <h3 class="mt-4">Leaderboard</h3>
    <ol id="leaderboard" class="list-decimal pl-5"></ol>


<!--    <textarea id="code" spellcheck="false"># Start here…
	print('hello lecture')</textarea> -->
  </div>
<!--
  <div class="io-grid">
    {% if ch.show_leaderboard %}
    <div class="panel">
      <div class="panel-title">Leaderboard</div>
      <ol id="leaderboard" class="lb"></ol>
    </div>
    {% endif %}
    <div class="panel">
      <div class="panel-title">Published Replays</div>
      <div id="replays"></div>
    </div>
  </div>
-->

<!-- Inline Replay Viewer (hidden until "Preview") -->
<!-- 
<div id="replay-viewer" style="display:none;" class="border rounded p-2 mb-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-muted">
      <strong>Previewing replay</strong> · <span id="rv-meta"></span>
    </div>
    <div class="flex gap-2">
      <button id="rv-load" class="btn btn-primary">Load into editor</button>
      <button id="rv-close" class="btn btn-secondary">Close</button>
    </div>
  </div>
  <label class="block text-sm font-semibold mb-1">Replay code (read-only)</label>
  <div id="rv-editor" class="border rounded" style="height: 260px;"></div>
  <label class="block text-sm font-semibold mt-2 mb-1">Replay last run output</label>
  <pre id="rv-output" class="border rounded p-2" style="max-height: 160px; overflow:auto; white-space: pre-wrap;"></pre>
</div>
-->
<!-- Recovery bar (appears if there is a backup) -->
<!--
<div id="recovery-bar" style="display:none;" class="border rounded p-2 bg-amber-50">
  <div class="flex items-center justify-between">
    <div class="text-sm">
      A previous version of your code was auto-saved (<span id="recovery-when"></span>).
    </div>
    <div class="flex gap-2">
      <button id="recovery-restore" class="btn btn-success">Restore my code</button>
      <button id="recovery-dismiss" class="btn btn-secondary">Dismiss</button>
    </div>
  </div>
</div>
-->
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<!-- CodeMirror (same versions as your weekly challenge is fine) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script>
const slug = {{ ch.slug|tojson }};
let keystrokes = [];
let startTime = null;

const outEl = document.getElementById('output');

const statusEl = document.getElementById('status');
const setStatus = (t) => { if (statusEl) statusEl.textContent = t; };


// --- CodeMirror init (matches weekly/sandbox) ---
function cmThemeFromPage() {
  return document.documentElement.getAttribute('data-theme') === 'dark' ? 'material' : 'eclipse';
}
const initialCode = {{ seed_code|default('', true)|tojson }};
const cm = CodeMirror(document.getElementById('editor'), {
  value: initialCode || "", //start empty
  placeholder: initialCode ? "" : "Start here...", // disappears on first input
  mode: 'python',
  theme: cmThemeFromPage(),
  lineNumbers: true,
  indentUnit: 4,
  viewportMargin: Infinity,
});
new MutationObserver((muts) => {
  for (const m of muts) if (m.attributeName === 'data-theme') cm.setOption('theme', cmThemeFromPage());
}).observe(document.documentElement, { attributes: true });
new MutationObserver((muts)=>{
  for (const m of muts) if (m.attributeName === 'data-theme') {
    const t = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'material' : 'eclipse';
    cm.setOption('theme', t);
    if (_rv.cm) _rv.cm.setOption('theme', t);      // <-- keep preview in sync
  }
}).observe(document.documentElement, { attributes: true });

// Recorder hooks -> keep your keystroke replay
function recordEvent(type, data){
  const t = Date.now() - (startTime ?? (startTime = Date.now()));
  keystrokes.push({ t, type, data });
}
cm.on('change', () => recordEvent('input', { value: cm.getValue() }));
cm.on('keydown', (_, e) => recordEvent('keydown', { key: e.key }));

// --- Pyodide Worker Hook (same message contract you used before) ---
let PY_WORKER = null;
let REQ_ID = 0;

function spawnWorker() {
  if (PY_WORKER) { try { PY_WORKER.terminate(); } catch(e) {} }
  PY_WORKER = new Worker("/static/js/py_runner_worker.js");
  return PY_WORKER;
}
spawnWorker();

async function runPython(code) {
  const id = ++REQ_ID;
  const w = PY_WORKER || spawnWorker();
  const reply = new Promise((resolve) => {
    const handler = (e) => { if (e.data && e.data.id === id) { w.removeEventListener("message", handler); resolve(e.data); } };
    w.addEventListener("message", handler);
    w.postMessage({ id, code });
  });
  const TIMEOUT_MS = 12000;
  const timeout = new Promise((resolve) => {
    setTimeout(() => { try { w.terminate(); } catch(e) {} spawnWorker(); resolve({ ok:false, timeout:true, error:"Time limit exceeded (12s)." }); }, TIMEOUT_MS);
  });
  const res = await Promise.race([reply, timeout]);
  let stdout = "", runtime = 0;
  if (res.ok) {
    stdout = (res.stdout || "").replace(/\r\n/g, "\n");
    runtime = res.runtime_ms || 0;
    outEl.textContent = [stdout, res.stderr].filter(Boolean).join("\n");
  } else {
    outEl.textContent = res.timeout ? res.error : ("Error: " + (res.error || "Unknown error"));
  }
  return { stdout, runtime_ms: runtime };
}

// Leaderboard + replays + my status
async function refreshLeaderboard(){
  const r = await fetch(`/api/lecture/${slug}/leaderboard`);
  const j = await r.json();
  const lb = document.getElementById('leaderboard'); lb.innerHTML = '';
  if(!j.ok) return;
  j.entries.forEach((e,i)=>{
    const li = document.createElement('li'); li.textContent = `${e.display_name}`; lb.appendChild(li);
  });
}
//async function refreshReplays(){
//  const r = await fetch(`/api/lecture/${slug}/replays`);
//  const j = await r.json();
//  const box = document.getElementById('replays'); box.innerHTML = '';
//  if(!j.ok) return;
//  j.items.forEach(item=>{
//    const row = document.createElement('div'); row.className='replay-item'; row.innerHTML = `<span>${item.display_name}</span>`;
//    const btn = document.createElement('button'); btn.textContent = 'Replay';
//    btn.onclick = async ()=>{
//      const rr = await fetch(`/api/lecture/submission/${item.submission_id}/replay`);
//      const jj = await rr.json(); if(!jj.ok) return;
//      const ks = jj.keystrokes ? JSON.parse(jj.keystrokes) : null;
//      cm.setValue((ks && ks.length) ? (ks[ks.length-1].data?.value ?? jj.code) : jj.code);
//      outEl.textContent = jj.run_output || '';
//      statusEl.textContent = `Loaded replay from ${jj.meta.display_name}`;
//    };
//    row.appendChild(btn); box.appendChild(row);
//  });
//}
// Buttons
document.getElementById('runBtn').addEventListener('click', async ()=>{
  const { stdout, runtime_ms } = await runPython(cm.getValue());
  setStatus(`Ran in ${runtime_ms} ms`);
});

function fetchWithTimeout(url, opts={}, ms=12000){
  const c = new AbortController();
  const id = setTimeout(()=>c.abort(), ms);
  return fetch(url, { ...opts, signal: c.signal }).finally(()=>clearTimeout(id));
}

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  setStatus('Submitting…')
  try {
    const { stdout, runtime_ms } = await runPython(cm.getValue());
    const payload = {
      code: cm.getValue(),
      keystrokes: JSON.stringify(keystrokes),
      run_output: stdout,
      runtime_ms
    };
    const r = await fetchWithTimeout(`/api/lecture/${slug}/submit`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }, 12000);
    const text = await r.text();
    let j = {}; try { j = JSON.parse(text); } catch {}
    if (!r.ok || j.ok === false) {
      statusEl.textContent = `Submit failed: ${j.error || text || r.status}`;
    } else {
      statusEl.textContent = 'Submitted! Waiting for instructor review.';
      refreshLeaderboard();fetchMyStatusAndRender();
    }
  } catch (e) {
    statusEl.textContent = `Network/timeout during submit`;
  }
});


</script>

<script>
(function(){
  const slug = {{ ch.slug|tojson }};
  const netid = {{ netid|default('', true)|tojson }};
  const listReplaysURL = `/api/lecture/${slug}/replays`;
  const replayJSONURL  = (sid) => `/api/lecture/submission/${sid}/replay`;

  // Elements
  const replaysToggle = document.getElementById('replaysToggle');
  const replaysMenu   = document.getElementById('replaysMenu');
  const restoreBtn    = document.getElementById('restoreBtn');
  const replayPanel   = document.getElementById('replayPanel');
  const rvMeta        = document.getElementById('rv-meta');
  const rvOutput      = document.getElementById('rv-output');
  const rvEditorHost  = document.getElementById('rv-editor');
  const rvLoadBtn     = document.getElementById('rv-load');
  const rvCloseBtn    = document.getElementById('rv-close');

  // Main editor helpers
  function getCM(){
    if (window.cm && typeof window.cm.getValue === 'function') return window.cm;
    if (window.editor && typeof window.editor.getValue === 'function') return window.editor;
    const el = document.querySelector('.CodeMirror'); return el && el.CodeMirror ? el.CodeMirror : null;
  }
  function setCurrentCode(txt){ const cm = getCM(); if (cm) cm.setValue(txt||''); }
  function setMainOutput(txt){ const out = document.getElementById('output'); if (out) out.textContent = txt || ''; }

  // Backup/restore
  const LS_KEY = `replayBackup:${slug}:${netid}`;
  function backup(){ try{ localStorage.setItem(LS_KEY, JSON.stringify({ code: getCM()?.getValue()||'', ts: Date.now() })); restoreBtn.style.display=''; }catch{} }
  function hasBackup(){ try{ return !!localStorage.getItem(LS_KEY); }catch{ return false; } }
  function restore(){ try{ const j = JSON.parse(localStorage.getItem(LS_KEY)||'null'); if (j) setCurrentCode(j.code||''); }catch{} }
  if (hasBackup()) restoreBtn.style.display = '';
  restoreBtn.addEventListener('click', restore);

  // Dropdown
  function hideMenu(){ replaysMenu.style.display='none'; }
  function toggleMenu(){ replaysMenu.style.display = (replaysMenu.style.display==='block')?'none':'block'; }
  replaysToggle.addEventListener('click', async ()=>{
    if (replaysMenu.style.display!=='block') await populateMenu();
    toggleMenu();
  });
  document.addEventListener('click', (e)=>{
    if (!replaysMenu.contains(e.target) && !replaysToggle.contains(e.target)) hideMenu();
  });

  async function populateMenu(){
    replaysMenu.innerHTML = '<div class="text-sm text-muted p-2">Loading…</div>';
    try{
      const res = await fetch(listReplaysURL, {headers:{'Accept':'application/json'}});
      if (!res.ok) { replaysMenu.innerHTML = `<div class="text-sm text-danger p-2">Failed (${res.status}).</div>`; return; }
      const data = await res.json();
      const items = data.items || [];
      if (!items.length){ replaysMenu.innerHTML = '<div class="text-sm text-muted p-2">No accepted solutions yet.</div>'; return; }
      replaysMenu.innerHTML = `
        <ul class="divide-y">
          ${items.map(i=>{
            const when = new Date(i.submitted_at).toLocaleString();
            return `<li class="p-2 flex items-center justify-between gap-2">
              <div class="truncate"><span class="font-mono text-sm">${i.netid}</span>
              <span class="text-xs text-muted">· ${when}</span></div>
              <div class="flex gap-1">
                <button class="btn btn-secondary btn-sm" data-prev="${i.submission_id}">Preview</button>
                <button class="btn btn-primary btn-sm" data-load="${i.submission_id}">Load</button>
              </div>
            </li>`;
          }).join('')}
        </ul>`;
      replaysMenu.querySelectorAll('[data-prev]').forEach(btn=>{
        btn.addEventListener('click', ()=> { previewReplay(btn.getAttribute('data-prev')); hideMenu(); });
      });
      replaysMenu.querySelectorAll('[data-load]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const sid = btn.getAttribute('data-load');
          const ok = await ensureReplayLoaded(sid);
          if (ok){ backup(); setCurrentCode(_rv.data.code||''); setMainOutput(_rv.data.run_output||''); }
          hideMenu();
          // focus editor so change is obvious
          const cm = getCM(); if (cm && cm.focus) { cm.focus(); setTimeout(()=>cm.refresh&&cm.refresh(),0); }
        });
      });
    }catch(e){ replaysMenu.innerHTML = '<div class="text-sm text-danger p-2">Failed to load.</div>'; }
  }

  // Inline preview
  let _rv = { cm:null, data:null, sid:null };
  
  function ensureRvCM(){
	  if (_rv.cm) return _rv.cm;
	  // Use the same theme as the main editor (fallback to current page theme)
	  const main = (window.cm || window.editor || null);
	  const theme = main && typeof main.getOption === 'function'
	    ? main.getOption('theme')
	    : (document.documentElement.getAttribute('data-theme') === 'dark' ? 'material' : 'eclipse');

	  _rv.cm = CodeMirror(rvEditorHost, {
	    value: '',
	    mode: 'python',
	    lineNumbers: true,
	    readOnly: 'nocursor',
	    indentUnit: 4,
	    theme,                    // <-- match main editor
	  });
	  _rv.cm.setSize(null, '100%');
	  return _rv.cm;
	}


  async function ensureReplayLoaded(sid){
    try{
      const res = await fetch(replayJSONURL(sid), {headers:{'Accept':'application/json'}});
      const data = await res.json();
      if (!data.ok) throw new Error('replay load failed');
      _rv.sid = sid; _rv.data = data; return true;
    }catch(e){ console.error(e); return false; }
  }
  async function previewReplay(sid){
    // Show the panel first so CodeMirror can size itself correctly
    replayPanel.style.display = '';
    const ok = await ensureReplayLoaded(sid);
    if (!ok) return;
    const cm = ensureRvCM();
    cm.setValue(_rv.data.code || '');
    rvOutput.textContent = _rv.data.run_output || '';
    rvMeta.textContent = ` · id ${sid}`;
    // IMPORTANT: refresh after showing the panel so first click works
    setTimeout(()=> cm.refresh && cm.refresh(), 0);
  }
  rvLoadBtn.addEventListener('click', ()=>{
    if (!_rv.data) return;
    backup();
    setCurrentCode(_rv.data.code || '');
    setMainOutput(_rv.data.run_output || '');
    const cm = getCM(); if (cm && cm.focus){ cm.focus(); setTimeout(()=>cm.refresh&&cm.refresh(),0); }
  });
  rvCloseBtn.addEventListener('click', ()=> { replayPanel.style.display='none'; _rv.data=null; _rv.sid=null; });
})();
</script>



<script>
function renderStatusCard(ctx){
  const html = `
    <section class="substatus-card" aria-labelledby="substatus-title">
      <header class="substatus-header">
        <span id="substatus-title" class="substatus-title">Submission Status</span>
        <span class="status-badge status-${ctx.status}" role="status" aria-live="polite">
          ${ctx.status === 'approved' ? '✓ APPROVED' : ctx.status === 'rejected' ? '✕ REJECTED' : '• PENDING'}
        </span>
        <span class="substatus-points">${ctx.points ?? '—'} pts</span>
      </header>
      <div class="feedback-card ${ctx.feedback ? '' : 'feedback-empty'}">
        <div class="feedback-label">Feedback</div>
        <div class="feedback-body">
          ${ctx.feedback ? ctx.feedback.replaceAll('\n','<br>') : '<span class="feedback-muted">No feedback yet.</span>'}
        </div>
      </div>
      ${ctx.updated_at ? `<footer class="substatus-meta">Last updated: ${ctx.updated_at}</footer>` : ''}
    </section>`;
  document.getElementById("submission-status").innerHTML = html;
}
</script>

<script>
let _statusSig = null;

async function fetchMyStatusAndRender(){
  const res = await fetch(`/api/lecture/${slug}/my_status`, {headers:{'Accept':'application/json'}});
  if (!res.ok) return;
  const j = await res.json();

  // Normalize → ctx for renderer
  const ctx = {
    status: (j.status || 'pending').toLowerCase(),
    points: j.points ?? null,
    feedback: j.feedback || "",
    updated_at: (j.updated_at || j.submitted_at || "").replace('T',' ').replace('Z','')
  };

  // Build a compact signature so we avoid unnecessary DOM updates
  const sig = `${ctx.status}|${ctx.points}|${ctx.feedback}|${ctx.updated_at}`;
  if (sig !== _statusSig){
    _statusSig = sig;
    renderStatusCard(ctx);
  }
}

function startStatusAutoRefresh(){
  let failures = 0;
  const base = 5000;          // 5s when visible
  const maxDelay = 60000;     // cap backoff at 60s

  async function tick(){
    try{
      await fetchMyStatusAndRender();
      failures = 0;
    }catch(e){
      failures++;
    }
    const backoff = Math.min(base * Math.pow(1.5, failures), maxDelay);
    const delay = document.hidden ? backoff * 2 : backoff;
    setTimeout(tick, delay);
  }

  // Keep things fresh when the tab becomes visible again
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) fetchMyStatusAndRender();
  });

  // First render immediately, then loop
  fetchMyStatusAndRender().finally(tick);
}
</script>

<script>
function startPolling(){
  // refresh leaderboard every 10s
  setInterval(refreshLeaderboard, 10000);
}
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  refreshLeaderboard();
  fetchMyStatusAndRender();
  startPolling();
  startStatusAutoRefresh();
});
</script>


{% endblock %}

