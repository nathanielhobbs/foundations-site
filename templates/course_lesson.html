{% extends "base.html" %}
{% block title %}{{ meta.title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/py_panel.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/ide_layout.css') }}">

<link id="hljsTheme" rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>

<style>
  /* Left-side step list styling */
  .muted{ color:#6b7280; font-size:.95rem; }
  .step-list{ list-style:none; padding:0; margin:.6rem 0 0 0; }
  .step-item{
    display:flex; justify-content:space-between; gap:10px;
    padding:.45rem .55rem; border-radius:10px; cursor:pointer;
    border:1px solid transparent;
  }
  .step-item:hover{ background: rgba(0,0,0,.04); }
  :root[data-theme="dark"] .step-item:hover{ background: rgba(255,255,255,.06); }
  .step-item.active{ border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.06); }
  .step-title{ font-weight:600; }
  .step-mark{ font-weight:800; width:1.2rem; text-align:center; }

  /* Prompt */
  .prompt{
    margin-top:12px;
    border-top:1px solid #e5e7eb;
    padding-top:12px;
  }
  .prompt pre{ overflow:auto; }
  .prompt code { background: rgba(0,0,0,0.06); padding: 0 .25rem; border-radius: 6px; }
  .prompt pre code { display:block; padding:.6rem; }

  /* Cmdline display */
  .cmdline{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:.9rem;
    background: rgba(0,0,0,0.04);
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:8px;
  }

  /* Toolbar row */
  .toolbar-row{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
  .argsBox{
    flex:1; min-width:240px;
    padding:.45rem .6rem;
    border-radius:8px;
    border:1px solid #bbb;
  }

  /* Make the right panels fill their panes nicely */
  #paneTop .py-panel{ height:100%; }
  #paneBottom .py-panel{ height:100%; }
  #paneBottom .py-out{ height: calc(100% - 56px); } /* subtract header+cmdline */

	  .cmdline-row{
	  display:flex;
	  gap:.5rem;
	  align-items:center;
	}
	.cmdline-row .cmdline{ flex: 1; }


  /* Ensure CodeMirror expands */
  .CodeMirror{ height:100% !important; }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom:.4rem;">{{ meta.title }}</h2>
<div class="muted">
  Course: <span style="font-weight:600;">{{ course }}</span>
  &nbsp;·&nbsp;
  Lesson: <span style="font-weight:600;">{{ lesson }}</span>
</div>

<div id="ide" class="ide" style="margin-top:1rem;">
  <!-- LEFT -->
  <div id="paneLeft" class="pane pane-left pad">
    <h3 style="margin:0 0 .35rem 0;">Steps</h3>
    <div class="muted">Click any step to practice. We’ll auto-check that step’s tests.</div>
    <ul id="stepList" class="step-list"></ul>

    <div class="prompt" id="prompt"></div>
  </div>

  <div class="gutter gutter-h" title="Drag to resize"></div>

  <!-- RIGHT -->
  <div class="pane pane-right">
    <div id="paneTop" class="pane" style="padding:12px;">
      <div class="py-panel">
        <div class="toolbar-row">
          <button id="runBtn" class="py-btn">Run</button>
          <input id="argsBox" class="argsBox" placeholder="args (optional), e.g. 10 20">
          <button id="checkBtn" class="py-btn">Check step</button>
          <button id="resetBtn" class="py-btn">Reset</button>
        </div>
        <textarea id="editor"></textarea>
      </div>
    </div>

    <div class="gutter gutter-v" title="Drag to resize"></div>

    <div id="paneBottom" class="pane" style="padding:12px;">
      <div class="py-panel">
        <h3 style="margin-top:0;">Output</h3>
	<div class="cmdline-row">
	  <div id="cmd" class="cmdline">$</div>
	  <button id="copyCmdBtn" class="py-btn" type="button" title="Copy command">Copy</button>
	</div>

        <div id="out" class="py-out" style="margin-top:.6rem;">
          <div class="system">Use Run to see print output. Check step runs the current step’s tests.</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script src="{{ url_for('static', filename='js/py_panel.js') }}"></script>
<script src="{{ url_for('static', filename='js/split_panes.js') }}"></script>

<script>
(function(){
  const COURSE = {{ course|tojson }};
  const LESSON = {{ lesson|tojson }};
  const META   = {{ meta|tojson }};
  const STEPS  = {{ (steps or [])|tojson }};
  const PROMPT_MD = {{ prompt_md|tojson }};
  const INITIAL_CODE = {{ initial_code|tojson }};
  const PROGRESS = {{ (progress or {})|tojson }};

  const outId = "out";
  const cmdEl = document.getElementById("cmd");

  // Render prompt (markdown -> HTML)
  function stepById(id){ return STEPS.find(s => String(s.id) === String(id)); }

  function stepStarter(){
    const s = stepById(activeStepId);
    return (s && s.starter_code) ? s.starter_code : (INITIAL_CODE || "");
  }

  function highlightPrompt(){
    if (!window.hljs) return;
    document.querySelectorAll("#prompt pre code").forEach(el => hljs.highlightElement(el));
  }

  function renderPrompt(){
    const s = stepById(activeStepId);
    const md = (s && s.prompt_md) ? s.prompt_md : (PROMPT_MD || "");
    document.getElementById("prompt").innerHTML = marked.parse(md);
  }

  function setHljsTheme(){
    const dark = document.documentElement.getAttribute("data-theme") === "dark";
    const el = document.getElementById("hljsTheme");
    if (!el) return;
    el.href = dark
      ? "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
      : "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css";
  }
  setHljsTheme();

  new MutationObserver(setHljsTheme).observe(document.documentElement, {attributes:true, attributeFilter:["data-theme"]});


  // Editor
  const editor = PyPanel.makeEditor("editor", {});
  editor.setValue(INITIAL_CODE || "");
  const starter = INITIAL_CODE || "";
  let settingValue = false;
	let dirty = false;

	editor.on("change", ()=>{
	  if (!settingValue) dirty = true;
	});

	function loadStepCode(stepId){
	  const s = STEPS.find(x => String(x.id) === String(stepId));
	  const code = (s && s.starter_code) ? s.starter_code : (INITIAL_CODE || "");
	  settingValue = true;
	  editor.setValue(code);
	  settingValue = false;
	  dirty = false;
	}
  // Split panes + persist sizes
  SplitPanes.init("ide", "paneLeft", "paneTop", "paneBottom", `course:${COURSE}:${LESSON}`);
  window.addEventListener("splitter:changed", ()=>{ try { editor.refresh(); } catch(e){} });

  // Steps UI state
  const stepList = document.getElementById("stepList");
  let activeStepId = STEPS.length ? STEPS[0].id : null;
  loadStepCode(activeStepId);
  function activeStep(){
    return STEPS.find(s => String(s.id) === String(activeStepId));
  }
  function renderCmdHint(){
    const s = activeStep();
    setCmd((s && s.cmd_hint) ? s.cmd_hint : "$");
  }

  renderPrompt();
  highlightPrompt()

  function isDone(stepId){ return !!PROGRESS[String(stepId)]; }

  function hasTests(s){
	  return !!(s && s.test_glob); // only true for coding steps with tests
	}

	async function setDone(stepId, done){
	  const r = await fetch(`/api/course/${COURSE}/${LESSON}/progress`, {
	    method:"POST",
	    headers: {"Content-Type":"application/json"},
	    body: JSON.stringify({ step_id: stepId, done })
	  });
	  if (!r.ok) return;
	  const j = await r.json();
	  if (j.progress){
	    for (const [k,v] of Object.entries(j.progress)) PROGRESS[k] = v;
	    renderSteps();
	    updateCheckButton();
	  }
	}

	function updateCheckButton(){
	  const btn = document.getElementById("checkBtn");
	  const s = activeStep();
	  if (!activeStepId){ btn.disabled = true; return; }

	  if (hasTests(s)){
	    btn.textContent = "Check step";
	    btn.disabled = false;
	  } else {
	    btn.textContent = isDone(activeStepId) ? "Mark incomplete" : "Mark complete";
	    btn.disabled = false;
	  }
	}


  function renderSteps(){
    stepList.innerHTML = "";
    if (!STEPS.length){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "No exercises in this lesson yet.";
      stepList.appendChild(li);
      document.getElementById("checkBtn").disabled = true;
      return;
    }
    document.getElementById("checkBtn").disabled = false;

    for(const s of STEPS){
      const li = document.createElement("li");
      li.className = "step-item" + (s.id === activeStepId ? " active" : "");

      const left = document.createElement("div");
      left.className = "step-title";
      left.textContent = s.title;

      const right = document.createElement("div");
      right.className = "step-mark";
      right.textContent = isDone(s.id) ? "✓" : "—";
      right.style.cursor = "pointer";
      right.title = isDone(s.id) ? "Mark incomplete" : "Mark complete";
      right.addEventListener("click", async (ev)=>{
        ev.stopPropagation();
        await setDone(s.id, !isDone(s.id));
      });


      li.appendChild(left);
      li.appendChild(right);

      li.addEventListener("click", ()=>{
        activeStepId = s.id;
	if (!dirty) {
	  loadStepCode(activeStepId);
	} else {
	  PyPanel.append(outId, "system", "You have edits. Click Reset to load this step’s starter.");
	}
	updateCheckButton()
	renderPrompt();
	highlightPrompt()
        renderSteps();
	renderCmdHint();
	const s2 = activeStep();
	if (hasTests(s2)) scheduleAutoCheck();

      });

      stepList.appendChild(li);
    }
  }
  renderSteps();
  updateCheckButton()
  renderCmdHint();

  function setCmd(s){ cmdEl.textContent = s || "$"; }

  // Auto-check (debounced)
  let checkTimer = null;
  let checkInFlight = false;

  function scheduleAutoCheck(){
    if (!STEPS.length) return;
    const s = stepById(activeStepId);
    if (!s || !s.test_glob) return;

    if (checkTimer) clearTimeout(checkTimer);
    checkTimer = setTimeout(async ()=>{
      if (checkInFlight) return;
      checkInFlight = true;
      try { await checkStep(); } finally { checkInFlight = false; }
    }, 250);
  }

  async function runCode(){
    PyPanel.resetOut(outId, "Running…");
    const args = document.getElementById("argsBox").value || "";
    setCmd("$ python main.py " + args);

    const r = await fetch(`/api/course/${COURSE}/${LESSON}/run`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ code: editor.getValue(), args })
    });

    const j = await r.json();
    setCmd(j.cmd_display || "$ python main.py");

    PyPanel.resetOut(outId);
    if (j.stdout) PyPanel.append(outId, "stdout", j.stdout);
    if (j.stderr) PyPanel.append(outId, "stderr", j.stderr);
    if (!j.stdout && !j.stderr) PyPanel.append(outId, "system", "No output.");
  }

  async function checkStep(){
    if (activeStepId == null){
      PyPanel.resetOut(outId);
      PyPanel.append(outId, "system", "No exercises in this lesson yet.");
      return;
    }

    PyPanel.resetOut(outId, "Running tests…");
    setCmd("$ pytest -q");

    const r = await fetch(`/api/course/${COURSE}/${LESSON}/check`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ step_id: activeStepId, code: editor.getValue() })
    });

    const txt = await r.text();
    if(!r.ok){
      PyPanel.resetOut(outId);
      PyPanel.append(outId, "stderr", `HTTP ${r.status}: ${txt}`);
      return;
    }

    const j = JSON.parse(txt);
    PyPanel.resetOut(outId);
    PyPanel.append(outId, "system", `Passed: ${j.passed}  Failed: ${j.failed}`);
    if (j.output) PyPanel.append(outId, "stdout", j.output);

    if (j.progress){
      for (const [k,v] of Object.entries(j.progress)) PROGRESS[k] = v;
      renderSteps();
    }
  }

  document.getElementById("runBtn").onclick = runCode;
  document.getElementById("checkBtn").onclick = async ()=>{
    const s = activeStep();
    if (hasTests(s)) return checkStep();
    return setDone(activeStepId, !isDone(activeStepId));
  };

  document.getElementById("resetBtn").onclick = ()=>{
    editor.setValue(stepStarter());
    PyPanel.resetOut(outId, "Reset.");
  };
  const copyBtn = document.getElementById("copyCmdBtn");
  if (copyBtn){
    copyBtn.onclick = async ()=>{
      const text = (cmdEl.textContent || "").trim();
      text = text.replace(/^\$\s*/, "");   // remove leading "$ "
      if (!text) return;

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          window.prompt("Copy command:", text);
          return;
        }
        const old = copyBtn.textContent;
        copyBtn.textContent = "Copied";
        setTimeout(()=> copyBtn.textContent = old, 800);
      } catch(e){
        window.prompt("Copy command:", text);
      }
    };
  }


})();
</script>
{% endblock %}

