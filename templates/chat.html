{% extends "base.html" %}
{% block title %}Live Chat ‚Äì Section {{ section }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-solarizedlight.min.css" id="prism-light-theme" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #siteWrapper {
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 1em;
    box-sizing: border-box;
  }

  /* Toggle switch styles */
  .toggle-switch {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-right: 12px;
  }
  .toggle-label {
    font-size: 0.95em;
    color: #666;
    margin-bottom: 2px;
  }
  .switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .2s;
    border-radius: 24px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .2s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background-color: #4ea1f3;
  }
  input:checked + .slider:before {
    transform: translateX(24px);
  }
  .toggle-text {
    font-size: 0.9em;
    margin-left: 8px;
    vertical-align: middle;
    color: #333;
  }
  #chatPage {
    display: flex;
    flex-direction: column;
    height: 100vh;
    min-height: 0;
  }
  #mainRow {
    display: flex;
    flex: 1 1 auto;
    min-height: 0;
  }
  #messagesContainer {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
    overflow: hidden;
    background-color: var(--bg);
    padding: 1em 0 0 0;
  }
  #messages {
    flex: 1 1 auto;
    overflow-y: auto;
    min-height: 0;
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    background-color: var(--bg);
  }
  #participantsSidebar {
    display: none;
    width: 220px;
    background: var(--bg);
    border-left: 1px solid #ccc;
    padding: 1em;
    overflow-y: auto;
    color: var(--text);
    max-height: 100%;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }
[data-theme="dark"] #participantsSidebar {
  background: #23272e;
  color: #e0e0e0;
}
#participantsSidebar h3 {
  margin-top: 0;
  margin-bottom: 0.7em;
}
#participantsList {
  list-style: none;
  padding: 0;
  margin: 0;
}
#participantsList li {
  padding: 2px 0 2px 0.5em;
  font-size: 1em;
  color: inherit;
  display: flex;
  align-items: center;
}
#participantsList li::before {
  content: '\2022'; /* bullet */
  color: #4ea1f3;
  font-size: 1.2em;
  margin-right: 0.5em;
  display: inline-block;
}
#chatButtonsRow {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
}
#inputBox {
  width: 100%;
  box-sizing: border-box;
  background: var(--bg);
  z-index: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-top: 5px;
}

  #msgInput {
    width: 100%;
    padding: 8px;
    min-height: 60px;
    resize: vertical;
  }

  #sendBtn {
    align-self: flex-end;
    padding: 8px 16px;
  }

  .message {
    margin-bottom: 10px;
    padding: 8px;
    background-color: #f0f0f0; /* Darker in light mode */
    border-left: 4px solid var(--bubble-border);
    border-radius: 6px;
    position: relative;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    border: 1px solid #e0e0e0;
  }
  /* Dark mode message styling */
  [data-theme="dark"] .message {
    background-color: #2d3748; /* Darker background for dark mode */
    border: 1px solid #4a5568;
    color: #e2e8f0; /* Light text for dark mode */
  }
  #messages .message + .message {
    margin-top: 8px;
  }

  .meta {
    font-size: 0.75em;
    color: var(--link);
    margin-bottom: 4px;
  }

  .content pre {
    margin: 0;
    white-space: pre-wrap;
    background: #f8f9fa; /* Light background for code in light mode */
    color: #000000; /* Pure black text for maximum contrast in light mode */
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
  }
  /* Dark mode code styling */
  [data-theme="dark"] .content pre {
    background: #2d3748; /* Dark background for code in dark mode */
    color: #e2e8f0; /* Light text for dark background */
    border: 1px solid #4a5568;
  }
  /* Remove Coy theme's box-shadow and background gradient in light mode */
  .content pre[class*="language-"] {
    box-shadow: none !important;
    background-image: none !important;
  }

  .reply-box {
    font-size: 0.8em;
    color: gray;
    padding: 4px;
    border-left: 2px solid var(--bubble-border);
    margin-bottom: 5px;
  }

  .result-bar {
    background-color: #4ea1f3;
    color: white;
    font-size: 0.75em;
    transition: width 0.3s ease;
    padding: 4px 8px;
    border-radius: 3px;
    margin-top: 4px;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    min-height: 20px;
    display: flex;
    align-items: center;
  }
  
  /* Dark mode poll results */
  [data-theme="dark"] .result-bar {
    background-color: #3182ce;
    color: #e2e8f0;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  
  /* Light mode poll results */
  [data-theme="light"] .result-bar {
    background-color: #2563eb;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  }
  
  /* Admin flags and support styling */
  .message-actions {
    display: none;
    position: absolute;
    top: 5px;
    right: 5px;
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 8px;
    box-shadow: none;
    z-index: 100;
    gap: 4px;
    flex-direction: column;
    min-width: auto;
  }
  
  .message:hover .message-actions {
    display: flex;
  }
  
  .admin-actions {
    display: flex;
    gap: 4px;
    flex-direction: row;
    flex-wrap: nowrap; /* Ensure single row, no wrapping */
  }
  
  .action-btn {
    padding: 8px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    background: transparent;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    width: 32px;
    height: 32px;
  }
  
  .action-btn:hover {
    color: #333;
    transform: scale(1.1);
  }
  
  .action-btn.delete {
    color: #dc2626;
  }
  
  .action-btn.delete:hover {
    color: #b91c1c;
  }
  
  .action-btn.correct {
    color: #059669;
  }
  
  .action-btn.correct:hover {
    color: #047857;
  }
  
  .action-btn.incorrect {
    color: #dc2626;
  }
  
  .action-btn.incorrect:hover {
    color: #b91c1c;
  }
  
  .action-btn.support {
    color: #4ea1f3;
  }
  
  .action-btn.support:hover {
    color: #3182ce;
  }
  
  .action-btn.flagged {
    opacity: 0.7;
  }
  
  /* Persistent status icons */
  .message-status {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 4px;
    z-index: 50;
  }
  
  .status-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
    font-weight: bold;
  }
  
  .status-icon.correct {
    background-color: #059669;
  }
  
  .status-icon.incorrect {
    background-color: #dc2626;
  }
  
  .status-icon.support {
    background-color: #4ea1f3;
    font-size: 10px;
  }
  
  /* Make messages relative positioned for absolute positioning of popups */
  .message {
    position: relative;
  }
  
  .admin-password-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  .admin-password-modal .modal-content {
    background: var(--bg);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #ccc;
    min-width: 300px;
  }
  
  .admin-password-modal input {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  
  .admin-password-modal button {
    background: #4ea1f3;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 8px;
  }
  
  .admin-password-modal button:hover {
    background: #3182ce;
  }
</style>
{% endblock %}

{% block content %}
<div id="chatPage">
  <div id="mainRow">
    <div id="messagesContainer">
      <div style="display: flex; align-items: flex-end; gap: 12px; margin-bottom: 0.5em;">
        <h2 style="margin: 0; font-size: 1.5em; line-height: 1.2;">Live Chat ‚Äì Section {{ section }}</h2>
        <span id="participantsCount" style="font-weight:normal; color:#4ea1f3; font-size:1.1em; line-height:1.2; padding-bottom:2px;">0 joined</span>
      </div>
      <div id="chatButtonsRow">
        <button id="toggleParticipants" type="button">Show Participants</button>
        <button onclick="showPollForm()" type="button">Create Poll</button>
        <button id="loginButton" type="button" style="margin-left: auto; display: none;">Login</button>
        <span id="loggedInMsg" style="margin-left: auto; color: #4ea1f3; font-size: 1em; display: none;"></span>
      </div>
      <div id="pollForm" style="display:none;">
        <input type="text" id="pollQuestion" placeholder="Poll question">
        <input type="text" id="pollOptions" placeholder="Options (comma-separated)">
        <button onclick="sendPoll()">Send Poll</button>
      </div>
      <div id="messages">
        {% for m in messages %}
          <div class="message" {% if m.type == 'poll' %}data-poll-id="{{ m.poll_id }}"{% endif %} data-message-id="{{ m.message_id }}">
            <!-- Persistent status icons -->
            <div class="message-status">
              {% if m.admin_flags.correct %}
                <div class="status-icon correct" title="Marked as correct">‚úì</div>
              {% endif %}
              {% if m.admin_flags.incorrect %}
                <div class="status-icon incorrect" title="Marked as incorrect">‚úó</div>
              {% endif %}
              {% if m.support_count > 0 %}
                <div class="status-icon support" title="{{ m.support_count }} support(s)">{{ m.support_count }}</div>
              {% endif %}
            </div>
            
            <!-- Popup action menu -->
            <div class="message-actions">
              <div class="admin-actions" style="display: none;">
                <button class="action-btn support" onclick="supportMessage('{{ m.message_id }}')" data-supported="{{ 'true' if m.support_votes and netid in m.support_votes else 'false' }}" title="Support this message">
                  üëç
                </button>
                <button class="action-btn delete" onclick="deleteMessage('{{ m.message_id }}')" title="Delete message">
                  üóëÔ∏è
                </button>
                <button class="action-btn correct" onclick="flagMessage('{{ m.message_id }}', 'correct')" {% if m.admin_flags.correct %}class="flagged"{% endif %} title="Mark as correct">
                  ‚úì
                </button>
                <button class="action-btn incorrect" onclick="flagMessage('{{ m.message_id }}', 'incorrect')" {% if m.admin_flags.incorrect %}class="flagged"{% endif %} title="Mark as incorrect">
                  ‚úó
                </button>
              </div>
              <button class="action-btn support student-support" onclick="supportMessage('{{ m.message_id }}')" data-supported="{{ 'true' if m.support_votes and netid in m.support_votes else 'false' }}" title="Support this message">
                üëç
              </button>
            </div>
            
            <div class="meta">
              {{ m.netid }} ‚Äî {{ m.timestamp }}{% if m.edited %} (edited){% endif %}{% if m.type == 'poll' %} (poll){% endif %}
            </div>
            {% if m.type == 'poll' %}
              <div style="font-weight: bold;">{{ m.question }}</div>
              {% for option in m.options %}
                <div style="margin-top: 5px;">
                  <button onclick="voteOnPoll('{{ m.poll_id }}', '{{ option }}')">{{ option }}</button>
                  <div class="result-bar" data-option="{{ option }}" style="width: 0;"></div>
                </div>
              {% endfor %}
            {% else %}
              {% if m.reply %}
                <div class="reply-box">{{ m.reply }}</div>
              {% endif %}
              <div class="content">
                {% set blocks = m.msg|split_code_blocks %}
                {% if blocks|length > 1 or (blocks and blocks[0].type == 'code') %}
                  {% for block in blocks %}
                    {% if block.type == 'code' %}
                      <pre><code class="language-python">{{ block.content|e }}</code></pre>
                    {% else %}
                      <span>{{ block.content|e }}</span>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <span>{{ m.msg|e }}</span>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    <div id="participantsSidebar">
      <h3 style="margin-bottom: 1em; display: flex; align-items: center; justify-content: space-between;">
        Participants
        <span id="sidebarParticipantsCount" style="font-weight:normal; color:#4ea1f3; font-size:0.98em; margin-left:0.7em;">(0)</span>
      </h3>
      <ul id="participantsList" style="display:block;"></ul>
    </div>
  </div>
  <div id="inputBox">
    <div id="loggedInMsg" style="font-size: 0.95em; color: #4ea1f3; margin-bottom: 4px; display: none;"></div>
    <div id="replyPreview" class="reply-box" style="display: none;"></div>
    <div style="display: flex; align-items: flex-end; gap: 16px;">
      <div class="toggle-switch">
        <span class="toggle-label">Render as:</span>
        <label class="switch">
          <input type="checkbox" id="inputModeToggle" checked>
          <span class="slider"></span>
        </label>
        <span id="toggleText" class="toggle-text">Code</span>
      </div>
      <textarea id="msgInput" placeholder="Ctrl+Enter to send."></textarea>
    </div>
  </div>
</div>

<!-- Admin Password Modal -->
<div id="adminPasswordModal" class="admin-password-modal" style="display: none;">
  <div class="modal-content">
    <h3>Admin Authentication</h3>
    <p>Enter your admin password to perform this action:</p>
    <input type="password" id="adminPassword" placeholder="Admin password">
    <div style="margin-top: 15px;">
      <button onclick="submitAdminAction()">Submit</button>
      <button onclick="cancelAdminAction()">Cancel</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="admin-password-modal" style="display: none;">
  <div class="modal-content">
    <h3>Login</h3>
    <p>Enter your NetID to join the chat:</p>
    <input type="text" id="loginNetID" placeholder="NetID">
    <div id="adminPasswordSection" style="display: none; margin-top: 10px;">
      <p>Admin password required:</p>
      <input type="password" id="loginAdminPassword" placeholder="Admin password">
    </div>
    <div style="margin-top: 15px;">
      <button onclick="submitLogin()">Login</button>
      <button onclick="cancelLogin()">Cancel</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
// Use a fallback for section in JS
var section = {{ section|tojson }};
const socket = io();
let replyTo = null;

document.addEventListener('DOMContentLoaded', function() {
  // Check if user is already logged in
  const storedNetid = localStorage.getItem("netid");
  const loginButton = document.getElementById('loginButton');
  const loggedInMsg = document.getElementById('loggedInMsg');
  if (loginButton && loggedInMsg) {
    if (storedNetid) {
      loginButton.style.display = 'none';
      const loginMessages = [
        `Let's wrangle a python, ${storedNetid}!`,
        `Ready to code, ${storedNetid}?`,
        `Welcome to the snake pit, ${storedNetid}!`,
        `Let's make some magic, ${storedNetid}!`,
        `Time to debug, ${storedNetid}!`,
        `Slither into some code, ${storedNetid}!`,
        `Let's get those tests passing, ${storedNetid}!`,
        `Show us your Pythonic moves, ${storedNetid}!`,
        `Let's byte into some problems, ${storedNetid}!`,
        `Keep calm and code on, ${storedNetid}!`
      ];
      const randomMsg = loginMessages[Math.floor(Math.random() * loginMessages.length)];
      loggedInMsg.textContent = randomMsg;
      loggedInMsg.style.display = 'inline-block';
    } else {
      loginButton.style.display = 'inline-block';
      loginButton.textContent = 'Login';
      loginButton.onclick = showLoginModal;
      loggedInMsg.style.display = 'none';
    }
  }

  // Toggle switch JS
  let inputMode = 'code';
  const inputModeToggle = document.getElementById('inputModeToggle');
  const msgInput = document.getElementById('msgInput');
  const toggleText = document.getElementById('toggleText');
  if (msgInput) {
    msgInput.style.fontFamily = 'monospace';
    msgInput.style.background = '#f7f7f7';
  }
  if (inputModeToggle) {
    inputModeToggle.onchange = function() {
      if (inputModeToggle.checked) {
        inputMode = 'code';
        toggleText.textContent = 'Code';
        msgInput.style.fontFamily = 'monospace';
        msgInput.style.background = '#f7f7f7';
        msgInput.placeholder = 'Ctrl+Enter to send.';
      } else {
        inputMode = 'text';
        toggleText.textContent = 'Text';
        msgInput.style.fontFamily = '';
        msgInput.style.background = '';
        msgInput.placeholder = 'Use triple backticks (```) for code blocks.\nCtrl+Enter to send.';
      }
    };
  }

  // Participants sidebar logic
  const sidebar = document.getElementById('participantsSidebar');
  const toggleBtn = document.getElementById('toggleParticipants');
  const participantsList = document.getElementById('participantsList');
  let sidebarVisible = false;
  if (toggleBtn && sidebar) {
    toggleBtn.onclick = function() {
      sidebarVisible = !sidebarVisible;
      console.log('Participants button clicked. Sidebar visible:', sidebarVisible);
      sidebar.style.display = sidebarVisible ? 'flex' : 'none';
      toggleBtn.textContent = sidebarVisible ? 'Hide Participants' : 'Show Participants';
      if (sidebarVisible) {
        socket.emit('get_participants', { section });
      }
    };
  }

  // Socket event handlers
  socket.on('participants', function(data) {
    console.log('Received participants event:', data);
    if (data.section != section) return;
    if (participantsList) participantsList.innerHTML = '';
    var count = (data.participants || []).length;
    const participantsCount = document.getElementById('participantsCount');
    const sidebarParticipantsCount = document.getElementById('sidebarParticipantsCount');
    if (participantsCount) participantsCount.textContent = `${count} joined`;
    if (sidebarParticipantsCount) sidebarParticipantsCount.textContent = `(${count})`;
    if (participantsList) {
      (data.participants || []).forEach(function(netid) {
        const li = document.createElement('li');
        li.textContent = netid;
        // Add kick icon for admin
        const isAdmin = localStorage.getItem('netid') === 'nh385' && localStorage.getItem('adminAuthenticated') === 'true';
        if (isAdmin && netid !== 'nh385') {
          const kickBtn = document.createElement('button');
          kickBtn.className = 'kick-btn';
          kickBtn.title = 'Kick user';
          kickBtn.innerHTML = 'üö´';
          kickBtn.style.marginLeft = '8px';
          kickBtn.style.display = 'none';
          // Refactored: Use checkAdminAuth and showAdminPasswordModal if needed
          kickBtn.onclick = function(e) {
            e.stopPropagation();
            function doKick() {
              const adminNetid = localStorage.getItem('netid');
              const adminPass = (typeof adminPassword !== 'undefined' ? adminPassword : null);
              console.log('KICK DEBUG:', { section, netid, admin_netid: adminNetid, admin_password: adminPass });
              socket.emit('kick_user', {
                section,
                netid,
                admin_netid: adminNetid,
                admin_password: adminPass
              });
            }
            if (!checkAdminAuth()) {
              showAdminPasswordModal(doKick);
              return;
            }
            if (confirm('Kick ' + netid + ' from this chat?')) {
              doKick();
            }
          };
          li.appendChild(kickBtn);
          li.onmouseenter = () => { kickBtn.style.display = 'inline-block'; };
          li.onmouseleave = () => { kickBtn.style.display = 'none'; };
        }
        participantsList.appendChild(li);
      });
    }
  });

  socket.on("poll_results", function(data) {
    const div = document.querySelector(`[data-poll-id="${data.poll_id}"]`);
    if (!div) return;

    const results = data.results;
    const total = Object.values(results).reduce((sum, val) => sum + parseInt(val || -1), 0);

    const bars = div.querySelectorAll(".result-bar");
    bars.forEach(bar => {
      const val = results[bar.dataset.option] || -1;
      const pct = total ? Math.round((val / total) * 99) : 0;
      bar.style.width = `${pct}%`;
      bar.textContent = `${val} vote${val !== "0" ? "s" : ""} (${pct}%)`;
    });
  });

  socket.on("message", function(data) {
    if (typeof data === "string") {
      addMessageObject({ msg: data, timestamp: "[old]", netid: "?", edited: false });
    } else {
      addMessageObject(data);
    }
  });

  // Only join if user is logged in
  const currentNetid = localStorage.getItem("netid");
  if (currentNetid) {
    console.log('Joining section', section, 'with netid', currentNetid);
    socket.emit("join", { section, netid: currentNetid });
  }

  // Scroll to bottom on load
  const messagesDiv = document.getElementById("messages");
  if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
  setupMessageToggles();
  // Ensure participants sidebar is hidden initially
  if (sidebar) sidebar.style.display = 'none';
  
  // Check admin status and show admin buttons if applicable
  checkAdminStatus();

  // Fetch poll results for historical polls
  const pollMessages = document.querySelectorAll('.message[data-poll-id]');
  pollMessages.forEach(function(pollDiv) {
    const pollId = pollDiv.getAttribute('data-poll-id');
    if (pollId) {
      console.log('Fetching results for poll:', pollId);
      socket.emit('get_poll_results', { poll_id: pollId });
    }
  });

  // Message input event handlers
  if (msgInput) {
    msgInput.addEventListener('focus', function handler(e) {
      if (e.target.value === '' && e.target.placeholder) {
        e.target.placeholder = '';
        e.target.removeEventListener('focus', handler);
      }
    });
    msgInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter" && e.ctrlKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  // Define sendMessage function inside DOMContentLoaded to access inputMode
  window.sendMessage = function() {
    const input = document.getElementById("msgInput");
    const replyPreview = document.getElementById("replyPreview");
    
    if (!input) return;
    
    let text = input.value.trim();
    const netid = localStorage.getItem("netid") || "unknown";

    if (text) {
      // If in code mode, wrap in triple backticks if not already
      if (inputMode === 'code' && !/^```[\s\S]*```$/.test(text)) {
        text = '```' + text + '```'; // Remove the \n to prevent extra newlines
      }
      // Remove username prefix - just send the message content
      const msg = replyTo ? `${text}|||reply|||${replyTo}` : text;
      socket.emit("message", { section, msg, netid });
      input.value = "";
      replyTo = null;
      if (replyPreview) replyPreview.style.display = "none";
    }
  };

  // Function to switch Prism theme based on current theme
  function switchPrismTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const lightTheme = document.getElementById('prism-light-theme');
    const darkTheme = document.querySelector('link[href*="prism-tomorrow"]');
    
    if (isDark) {
      // Use dark theme
      if (lightTheme) lightTheme.disabled = true;
      if (darkTheme) darkTheme.disabled = false;
    } else {
      // Use light theme
      if (lightTheme) lightTheme.disabled = false;
      if (darkTheme) darkTheme.disabled = true;
    }
    
    // Re-highlight all code blocks
    if (window.Prism) {
      Prism.highlightAll();
    }
  }

  // Switch theme on page load
  switchPrismTheme();

  // Listen for theme changes (if your theme system triggers events)
  // Now, use a MutationObserver to watch for data-theme changes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        switchPrismTheme();
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });

  // Section dropdown auto-redirect (generalized and persistent)
  function setupSectionDropdownRedirect() {
    var dropdown = document.getElementById('sectionDropdown') || document.getElementById('sectionSelect');
    var storedSection = localStorage.getItem('section');
    var urlSection = String(section);

    // If the URL section does not match localStorage.section, redirect
    if (storedSection && storedSection !== urlSection) {
      window.location.href = '/chat/' + storedSection;
      return;
    }

    // Set dropdown to stored section if present
    if (dropdown && storedSection) {
      dropdown.value = storedSection;
    }

    // On dropdown change, update localStorage and redirect
    if (dropdown) {
      dropdown.addEventListener('change', function(e) {
        var value = e.target.value;
        localStorage.setItem('section', value);
        if (window.location.pathname.startsWith('/chat/')) {
          window.location.href = '/chat/' + value;
        } else if (window.location.pathname.startsWith('/notebooks')) {
          window.location.href = '/notebooks?section=' + value;
        }
      });
    }
  }
  setupSectionDropdownRedirect();

  // Add this after the login modal is created, inside DOMContentLoaded
  const loginNetID = document.getElementById('loginNetID');
  const loginAdminPassword = document.getElementById('loginAdminPassword');
  if (loginNetID) {
    loginNetID.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        submitLogin();
      }
    });
  }
  if (loginAdminPassword) {
    loginAdminPassword.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        submitLogin();
      }
    });
  }
});

// Functions that don't depend on DOM elements
function showPollForm() {
  const pollForm = document.getElementById("pollForm");
  if (pollForm) pollForm.style.display = "block";
}

function sendPoll() {
  const question = document.getElementById("pollQuestion");
  const options = document.getElementById("pollOptions");
  const pollForm = document.getElementById("pollForm");
  
  if (!question || !options || !pollForm) return;
  
  const questionText = question.value.trim();
  const optionsList = options.value.split(",").map(o => o.trim()).filter(Boolean);
  const netid = localStorage.getItem("netid") || "unknown";

  if (!questionText || optionsList.length < 2) {
    alert("Enter a question and at least two options.");
    return;
  }

  socket.emit("poll", { section, question: questionText, options: optionsList, netid });

  pollForm.style.display = "none";
  question.value = "";
  options.value = "";
}

// Admin functionality
let pendingAdminAction = null;
let adminPassword = null;

// Check if admin is already authenticated
function checkAdminAuth() {
  const netid = localStorage.getItem("netid");
  const isAuthenticated = localStorage.getItem("adminAuthenticated") === "true";
  
  if (netid === 'nh385' && isAuthenticated) {
    adminPassword = 'foundationsP4ss;';
    return true;
  }
  return false;
}

function showAdminPasswordModal(action) {
  pendingAdminAction = action;
  document.getElementById('adminPasswordModal').style.display = 'flex';
  document.getElementById('adminPassword').focus();
}

function submitAdminAction() {
  const password = document.getElementById('adminPassword').value;
  if (!password) {
    alert('Please enter the admin password');
    return;
  }
  
  if (password === 'foundationsP4ss;') {
    adminPassword = password;
    localStorage.setItem("adminAuthenticated", "true");
    document.getElementById('adminPasswordModal').style.display = 'none';
    document.getElementById('adminPassword').value = '';
    
    if (pendingAdminAction) {
      pendingAdminAction();
      pendingAdminAction = null;
    }
  } else {
    alert('Invalid admin password');
    document.getElementById('adminPassword').value = '';
  }
}

function cancelAdminAction() {
  document.getElementById('adminPasswordModal').style.display = 'none';
  document.getElementById('adminPassword').value = '';
  pendingAdminAction = null;
}

function deleteMessage(messageId) {
  if (!checkAdminAuth()) {
    showAdminPasswordModal(() => deleteMessage(messageId));
    return;
  }
  
  const netid = localStorage.getItem("netid") || "unknown";
  socket.emit("admin_delete_message", {
    section: section,
    message_id: messageId,
    netid: netid,
    password: adminPassword
  });
}

function flagMessage(messageId, flagType) {
  if (!checkAdminAuth()) {
    showAdminPasswordModal(() => flagMessage(messageId, flagType));
    return;
  }
  
  const netid = localStorage.getItem("netid") || "unknown";
  socket.emit("admin_flag_message", {
    section: section,
    message_id: messageId,
    flag_type: flagType,
    netid: netid,
    password: adminPassword
  });
}

function supportMessage(messageId) {
  const netid = localStorage.getItem("netid") || "unknown";
  socket.emit("support_message", {
    section: section,
    message_id: messageId,
    netid: netid
  });
}

// Login/Logout functionality
function showLoginModal() {
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('loginNetID').focus();
}

function cancelLogin() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('loginNetID').value = '';
  document.getElementById('loginAdminPassword').value = '';
  document.getElementById('adminPasswordSection').style.display = 'none';
}

function submitLogin() {
  const netid = document.getElementById('loginNetID').value.trim();
  const adminPassword = document.getElementById('loginAdminPassword').value;
  
  if (!netid) {
    alert('Please enter your NetID');
    return;
  }
  
  // Check if admin login
  if (netid === 'nh385') {
    if (!adminPassword) {
      document.getElementById('adminPasswordSection').style.display = 'block';
      document.getElementById('loginAdminPassword').focus();
      return;
    }
    
    if (adminPassword !== 'foundationsP4ss;') {
      alert('Invalid admin password');
      document.getElementById('loginAdminPassword').value = '';
      return;
    }
    
    // Admin login successful
    localStorage.setItem("netid", netid);
    localStorage.setItem("adminAuthenticated", "true");
    localStorage.setItem("netidDate", new Date().toISOString().slice(0, 10));
  } else {
    // Regular user login
    localStorage.setItem("netid", netid);
    localStorage.removeItem("adminAuthenticated");
    localStorage.setItem("netidDate", new Date().toISOString().slice(0, 10));
  }
  
  // Update UI
  document.getElementById('loginButton').textContent = `Logged in as ${netid}`;
  document.getElementById('loginButton').onclick = showLogoutConfirm;
  
  // Close modal
  cancelLogin();
  
  // Join chat with new NetID
  socket.emit("join", { section, netid });
  
  // Check admin status
  checkAdminStatus();
}

function showLogoutConfirm() {
  // No longer needed: do nothing
}

function logout() {
  // No longer needed: do nothing
}

// Check if user is admin and show admin buttons
function checkAdminStatus() {
  const netid = localStorage.getItem("netid");
  const isAuthenticated = localStorage.getItem("adminAuthenticated") === "true";
  
  if (netid === 'nh385' && isAuthenticated) {
    document.querySelectorAll('.admin-actions').forEach(el => {
      el.style.display = 'flex';
    });
    document.querySelectorAll('.student-support').forEach(el => {
      el.style.display = 'none';
    });
  } else {
    document.querySelectorAll('.admin-actions').forEach(el => {
      el.style.display = 'none';
    });
    document.querySelectorAll('.student-support').forEach(el => {
      el.style.display = 'flex';
    });
  }
}

// Handle admin action responses
socket.on("admin_error", function(data) {
  alert("Admin Error: " + data.message);
  adminPassword = null; // Clear password on error
});

socket.on("message_deleted", function(data) {
  const messageEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
  if (messageEl) {
    messageEl.remove();
  }
});

socket.on("message_flagged", function(data) {
  const messageEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
  if (messageEl) {
    // Update status icons
    const statusDiv = messageEl.querySelector('.message-status');
    if (statusDiv) {
      statusDiv.innerHTML = '';
      
      if (data.admin_flags.correct) {
        const correctIcon = document.createElement("div");
        correctIcon.className = "status-icon correct";
        correctIcon.title = "Marked as correct";
        correctIcon.textContent = "‚úì";
        statusDiv.appendChild(correctIcon);
      }
      
      if (data.admin_flags.incorrect) {
        const incorrectIcon = document.createElement("div");
        incorrectIcon.className = "status-icon incorrect";
        incorrectIcon.title = "Marked as incorrect";
        incorrectIcon.textContent = "‚úó";
        statusDiv.appendChild(incorrectIcon);
      }
    }
    
    // Update button states
    const correctBtn = messageEl.querySelector('.action-btn.correct');
    const incorrectBtn = messageEl.querySelector('.action-btn.incorrect');
    if (correctBtn) correctBtn.classList.toggle('flagged', data.admin_flags.correct);
    if (incorrectBtn) incorrectBtn.classList.toggle('flagged', data.admin_flags.incorrect);
  }
});

socket.on("message_supported", function(data) {
  const messageEl = document.querySelector(`[data-message-id="${data.message_id}"]`);
  if (messageEl) {
    // Update support button
    const supportBtn = messageEl.querySelector('.action-btn.support');
    if (supportBtn) {
      supportBtn.classList.toggle('supported', data.supported);
    }
    
    // Update status icons
    const statusDiv = messageEl.querySelector('.message-status');
    if (statusDiv) {
      // Remove existing support icon
      const existingSupport = statusDiv.querySelector('.status-icon.support');
      if (existingSupport) {
        existingSupport.remove();
      }
      
      // Add new support icon if count > 0
      if (data.support_count > 0) {
        const supportIcon = document.createElement("div");
        supportIcon.className = "status-icon support";
        supportIcon.title = `${data.support_count} support(s)`;
        supportIcon.textContent = data.support_count;
        statusDiv.appendChild(supportIcon);
      }
    }
  }
});

socket.on("support_error", function(data) {
  alert("Support Error: " + data.message);
});

// Handle being kicked from the chat
socket.on('kicked', function(data) {
  alert(data.reason || 'You have been removed from the chat.');
  // Force logout and reload page
  logout();
  window.location.reload();
});

function escapeHtml(text) {
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;");
}

function stripNetid(msg) {
  return msg.includes(":") ? msg.split(":").slice(1).join(":").trim() : msg;
}

function splitCodeBlocksJS(value) {
  // Returns [{type: 'code'|'text', content: ...}]
  const parts = value.split(/(```)/);
  let inCode = false;
  let buffer = '';
  const result = [];
  for (const part of parts) {
    if (part === '```') {
      if (buffer) {
        result.push({ type: inCode ? 'code' : 'text', content: buffer });
        buffer = '';
      }
      inCode = !inCode;
    } else {
      buffer += part;
    }
  }
  if (buffer) {
    result.push({ type: inCode ? 'code' : 'text', content: buffer });
  }
  return result;
}

function getESTTimestamp() {
  const now = new Date();
  const estTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
  
  return estTime.toLocaleDateString('en-US', { 
    month: '2-digit', 
    day: '2-digit' 
  }) + ' ' + estTime.toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
  });
}

function formatTimestampForDisplay(timestampStr) {
  // If it's an old message or unknown, generate current EST time
  if (timestampStr === "[old]" || timestampStr === "[unknown]") {
    return getESTTimestamp();
  }
  
  // If it already has a date format (MM/DD HH:MM), check if it's today
  if (timestampStr.includes(' ') && timestampStr.includes('/')) {
    try {
      const [datePart, timePart] = timestampStr.split(' ');
      const [month, day] = datePart.split('/');
      
      const now = new Date();
      const estTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
      const today = estTime.toLocaleDateString('en-US', { 
        month: '2-digit', 
        day: '2-digit' 
      });
      
      // If it's today, just show time
      if (datePart === today) {
        return timePart;
      } else {
        return timestampStr; // Show full date/time if different day
      }
    } catch (e) {
      return timestampStr; // If parsing fails, return original
    }
  }
  
  return timestampStr; // Return as is if not in expected format
}

function addMessageObject(data) {
  const messages = document.getElementById("messages");
  if (!messages) return;
  
  if (data.type === "poll") {
    const div = document.createElement("div");
    div.className = "message";
    div.dataset.pollId = data.poll_id;
    div.dataset.messageId = data.message_id || `poll:${data.poll_id}`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${data.netid} ‚Äî ${data.timestamp} (poll)`;
    div.appendChild(meta);

    const question = document.createElement("div");
    question.textContent = data.question;
    question.style.fontWeight = "bold";
    div.appendChild(question);

    data.options.forEach(option => {
      const wrapper = document.createElement("div");
      wrapper.style.marginTop = "5px";

      const btn = document.createElement("button");
      btn.textContent = option;
      btn.onclick = () => voteOnPoll(data.poll_id, option);
      wrapper.appendChild(btn);

      const result = document.createElement("div");
      result.className = "result-bar";
      result.dataset.option = option;
      result.style.width = "0";
      wrapper.appendChild(result);

      div.appendChild(wrapper);
    });

    messages.appendChild(div);
    div.scrollIntoView({ behavior: "smooth" });
    return;
  }

  const div = document.createElement("div");
  div.className = "message";
  div.dataset.messageId = data.message_id || `msg:${Date.now()}:${Math.random()}`;

  const meta = document.createElement("div");
  meta.className = "meta";
  // Use proper timestamp formatting
  const timestamp = formatTimestampForDisplay(data.timestamp);
  meta.textContent = `${data.netid} ‚Äî ${timestamp}${data.edited ? " (edited)" : ""}`;
  
  // Add admin flags if they exist
  if (data.admin_flags && Object.keys(data.admin_flags).length > 0) {
    const adminFlags = document.createElement("div");
    adminFlags.className = "admin-flags";
    if (data.admin_flags.correct) {
      adminFlags.innerHTML += '<span class="flag-badge correct">‚úì Correct</span>';
    }
    if (data.admin_flags.incorrect) {
      adminFlags.innerHTML += '<span class="flag-badge incorrect">‚úó Incorrect</span>';
    }
    meta.appendChild(adminFlags);
  }
  
  div.appendChild(meta);

  if (data.reply) {
    const reply = document.createElement("div");
    reply.className = "reply-box";
    reply.textContent = data.reply.length > 100 ? data.reply.slice(0, 100) + "..." : data.reply;
    div.appendChild(reply);
  }

  // Handle both old messages (with username prefix) and new messages (without prefix)
  let content = data.msg || "";
  if (content.includes(":") && !content.startsWith("```")) {
    // This is likely an old message with username prefix, strip it
    const colonIndex = content.indexOf(":");
    if (colonIndex > 0) {
      content = content.substring(colonIndex + 1).trim();
    }
  }
  
  const blocks = splitCodeBlocksJS(content);
  const contentDiv = document.createElement("div");
  contentDiv.className = "content";

  if (blocks.length > 1 || (blocks.length && blocks[0].type === 'code')) {
    blocks.forEach(block => {
      if (block.type === 'code') {
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.className = 'language-python';
        code.textContent = block.content;
        pre.appendChild(code);
        contentDiv.appendChild(pre);
        Prism.highlightElement(code);
      } else {
        const span = document.createElement('span');
        span.textContent = block.content;
        contentDiv.appendChild(span);
      }
    });
  } else {
    const span = document.createElement('span');
    span.textContent = content;
    contentDiv.appendChild(span);
  }

  div.appendChild(contentDiv);

  // Add persistent status icons
  const statusDiv = document.createElement("div");
  statusDiv.className = "message-status";
  
  if (data.admin_flags && data.admin_flags.correct) {
    const correctIcon = document.createElement("div");
    correctIcon.className = "status-icon correct";
    correctIcon.title = "Marked as correct";
    correctIcon.textContent = "‚úì";
    statusDiv.appendChild(correctIcon);
  }
  
  if (data.admin_flags && data.admin_flags.incorrect) {
    const incorrectIcon = document.createElement("div");
    incorrectIcon.className = "status-icon incorrect";
    incorrectIcon.title = "Marked as incorrect";
    incorrectIcon.textContent = "‚úó";
    statusDiv.appendChild(incorrectIcon);
  }
  
  if (data.support_count > 0) {
    const supportIcon = document.createElement("div");
    supportIcon.className = "status-icon support";
    supportIcon.title = `${data.support_count} support(s)`;
    supportIcon.textContent = data.support_count;
    statusDiv.appendChild(supportIcon);
  }
  
  div.appendChild(statusDiv);

  // Add popup action menu
  const actionsDiv = document.createElement("div");
  actionsDiv.className = "message-actions";
  
  // Support button
  const supportBtn = document.createElement("button");
  supportBtn.className = "action-btn support";
  supportBtn.onclick = () => supportMessage(div.dataset.messageId);
  supportBtn.title = "Support this message";
  const isSupported = data.support_votes && data.support_votes.includes(localStorage.getItem("netid"));
  if (isSupported) supportBtn.classList.add("supported");
  supportBtn.innerHTML = "üëç";
  actionsDiv.appendChild(supportBtn);
  
  // Admin actions (hidden by default)
  const adminActions = document.createElement("div");
  adminActions.className = "admin-actions";
  adminActions.style.display = "none";
  
  const deleteBtn = document.createElement("button");
  deleteBtn.className = "action-btn delete";
  deleteBtn.innerHTML = "üóëÔ∏è";
  deleteBtn.title = "Delete message";
  deleteBtn.onclick = () => deleteMessage(div.dataset.messageId);
  adminActions.appendChild(deleteBtn);
  
  const correctBtn = document.createElement("button");
  correctBtn.className = "action-btn correct";
  correctBtn.innerHTML = "‚úì";
  correctBtn.title = "Mark as correct";
  correctBtn.onclick = () => flagMessage(div.dataset.messageId, "correct");
  if (data.admin_flags && data.admin_flags.correct) correctBtn.classList.add("flagged");
  adminActions.appendChild(correctBtn);
  
  const incorrectBtn = document.createElement("button");
  incorrectBtn.className = "action-btn incorrect";
  incorrectBtn.innerHTML = "‚úó";
  incorrectBtn.title = "Mark as incorrect";
  incorrectBtn.onclick = () => flagMessage(div.dataset.messageId, "incorrect");
  if (data.admin_flags && data.admin_flags.incorrect) incorrectBtn.classList.add("flagged");
  adminActions.appendChild(incorrectBtn);
  
  actionsDiv.appendChild(adminActions);
  div.appendChild(actionsDiv);

  div.addEventListener("click", () => {
    replyTo = data.msg;
    const box = document.getElementById("replyPreview");
    if (box) {
      box.textContent = "‚Ü™ " + content.slice(0, 80);
      box.style.display = "block";
    }
  });

  messages.appendChild(div);
  div.scrollIntoView({ behavior: "smooth" });
  
  // Check if admin buttons should be shown
  checkAdminStatus();
}

function voteOnPoll(pollId, option) {
  const netid = localStorage.getItem("netid") || "unknown";
  socket.emit("vote", { poll_id: pollId, option, netid });
}

// Add toggle logic for message display mode
function setupMessageToggles() {
  document.querySelectorAll('.content').forEach(function(content) {
    const btn = content.querySelector('.msg-toggle-btn');
    const textSpan = content.querySelector('.msg-text');
    const codePre = content.querySelector('.msg-code');
    if (!btn || !textSpan || !codePre) return;
    btn.onclick = function() {
      if (textSpan.style.display === 'none') {
        textSpan.style.display = 'inline';
        codePre.style.display = 'none';
        btn.textContent = 'Show as code';
      } else {
        textSpan.style.display = 'none';
        codePre.style.display = 'block';
        btn.textContent = 'Show as text';
        Prism.highlightAllUnder(codePre); // Highlight all code blocks within this content div
      }
    };
  });
}
</script>
{% endblock %}


