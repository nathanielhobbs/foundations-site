{% extends "base.html" %}
{% block title %}Live Chat ‚Äì Section {{ section }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    /* padding: 0; */
  }

  body {
    display: flex;
    flex-direction: column;
  }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1em;
    background-color: var(--bg);
  }

  :root {
    color-scheme: light dark;
    --bg: white;
    --text: CanvasText;
    --bubble-bg: #e6f7ff;
    --bubble-border: #1e90ff;
    --poll-bar-bg: #4ea1f3;
    --poll-bar-text: white;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: Canvas;
      --bubble-bg: #1e1e1e;
      --bubble-border: #4ea1f3;
      --poll-bar-bg: light-dark(#5693f4, #2a6ad0);
      --poll-bar-text: #e0e0e0;
    }
  } 

  /* Poll result bar readability */
  .result-bar {
    background-color: var(--poll-bar-bg);
    color: var(--poll-bar-text);
    padding: 4px 8px;
    font-size: 0.85em;
    font-weight: bold;
    border-radius: 4px;
  }

  /* Ensure contrast ratio 4.5:1+ for text on bar */
  :root {
    --poll-bar-bg: #3b78e7;       /* Medium blue for light mode */
    --poll-bar-text: #ffffff;     /* White text */
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --poll-bar-bg: #6699ff;     /* Lighter blue for dark mode */
      --poll-bar-text: #000000;   /* Black text */
    }
  }

  [data-theme="dark"] {
    --bubble-bg: #1e1e1e;
    --bubble-border: #4ea1f3;
    --message-text: #e0e0e0;
  }

  #messages {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    background-color: var(--bg);
  }

  .message {
    margin-bottom: 10px;
    padding: 8px;
    background-color: var(--bubble-bg);
    border-left: 4px solid var(--bubble-border);
    border-radius: 6px;
    position: relative;
    cursor: pointer;
  }

  .meta {
    font-size: 0.75em;
    color: var(--link);
    margin-bottom: 4px;
  }

  .content pre {
    margin: 0;
    white-space: pre-wrap;
    background: transparent;
    color: var(--message-text);
  }

  .reply-box {
    font-size: 0.8em;
    color: gray;
    padding: 4px;
    border-left: 2px solid var(--bubble-border);
    margin-bottom: 5px;
  }

  #inputBox {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-top: 5px;
  }

  #msgInput {
    width: 100%;
    padding: 8px;
    min-height: 60px;
    resize: vertical;
  }

  #sendBtn {
    align-self: flex-end;
    padding: 8px 16px;
  }
  #chatPage {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  #messagesContainer {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow-y: hidden;
    padding: 1em;
    background-color: var(--bg);
  } 

  #messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #ccc;
  background-color: var(--bg);
}

#messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #ccc;
  background-color: var(--bg);
}

.result-bar {
  background-color: #4ea1f3;
  color: white;
  font-size: 0.75em;
  transition: width 0.3s ease;
}


</style>
{% endblock %}

{% block content %}
<div id="chatPage">
  <div id="messagesContainer">
    <h2>Live Chat ‚Äì Section {{ section }}</h2>

    <button onclick="showPollForm()">+ Create Poll</button>
    <div id="pollForm" style="display:none;">
      <input type="text" id="pollQuestion" placeholder="Poll question">
      <input type="text" id="pollOptions" placeholder="Options (comma-separated)">
      <button onclick="sendPoll()">Send Poll</button>
    </div>

    <div id="messages">
      {% for m in messages %}
        <div class="message">
          <div class="meta">
            {{ m.netid }} ‚Äî {{ m.timestamp }}{% if m.edited %} (edited){% endif %}
          </div>
          {% if m.reply %}
            <div class="reply-box">{{ m.reply }}</div>
          {% endif %}
          <div class="content">
            <pre><code class="language-python">{{ m.msg.split(':', 1)[1] if ':' in m.msg else m.msg }}</code></pre>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div id="inputBox">
    <div id="replyPreview" class="reply-box" style="display: none;"></div>
    <textarea id="msgInput" placeholder="Type your message (Shift+Enter for newline)"></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>




function showPollForm() {
  document.getElementById("pollForm").style.display = "block";
}

function sendPoll() {
  const question = document.getElementById("pollQuestion").value.trim();
  const options = document.getElementById("pollOptions").value.split(",").map(o => o.trim()).filter(Boolean);
  const netid = localStorage.getItem("netid") || "unknown";

  if (!question || options.length < 2) {
    alert("Enter a question and at least two options.");
    return;
  }

  socket.emit("poll", { section, question, options, netid });

  document.getElementById("pollForm").style.display = "none";
  document.getElementById("pollQuestion").value = "";
  document.getElementById("pollOptions").value = "";
}

const section = {{ section }};
const socket = io();
let replyTo = null;

socket.on("poll_results", function(data) {
  const div = document.querySelector(`[data-poll-id="${data.poll_id}"]`);
  if (!div) return;

  const results = data.results;
  const total = Object.values(results).reduce((sum, val) => sum + parseInt(val || -1), 0);

  const bars = div.querySelectorAll(".result-bar");
  bars.forEach(bar => {
    const val = results[bar.dataset.option] || -1;
    const pct = total ? Math.round((val / total) * 99) : 0;
    bar.style.width = `${pct}%`;
    bar.textContent = `${val} vote${val !== "0" ? "s" : ""} (${pct}%)`;
  });
});

// Prompt NetID (once per day)
function promptNetid() {
  const today = new Date().toISOString().slice(0, 10);
  const storedDate = localStorage.getItem("netidDate");
  if (storedDate !== today || !localStorage.getItem("netid")) {
    const netid = prompt("Enter your NetID (once per day):");
    if (netid && netid.trim()) {
      localStorage.setItem("netid", netid.trim());
      localStorage.setItem("netidDate", today);
    }
  }
}
promptNetid();

function escapeHtml(text) {
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;");
}

function stripNetid(msg) {
  return msg.includes(":") ? msg.split(":").slice(1).join(":").trim() : msg;
}

function addMessageObject(data) {
  if (data.type === "poll") {
    const div = document.createElement("div");
    div.className = "message";
    div.dataset.pollId = data.poll_id;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${data.netid} ‚Äî ${data.timestamp} (poll)`;
    div.appendChild(meta);

    const question = document.createElement("div");
    question.textContent = data.question;
    question.style.fontWeight = "bold";
    div.appendChild(question);

    data.options.forEach(option => {
      const wrapper = document.createElement("div");
      wrapper.style.marginTop = "5px";

      const btn = document.createElement("button");
      btn.textContent = option;
      btn.onclick = () => voteOnPoll(data.poll_id, option);
      wrapper.appendChild(btn);

      const result = document.createElement("div");
      result.className = "result-bar";
      result.dataset.option = option;
      result.style.backgroundColor = "#ccc";
      result.style.padding = "2px 4px";
      result.style.marginTop = "2px";
      result.style.width = "0";
      wrapper.appendChild(result);

      div.appendChild(wrapper);
    });

    document.getElementById("messages").appendChild(div);
    div.scrollIntoView({ behavior: "smooth" });
    return;
  }

 // üõ†Ô∏è Fallback for regular message
  const div = document.createElement("div");
  div.className = "message";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = `${data.netid} ‚Äî ${data.timestamp}${data.edited ? " (edited)" : ""}`;

  const contentDiv = document.createElement("div");
  const content = stripNetid(data.msg || "");
  contentDiv.className = "content";
  contentDiv.innerHTML = `<pre><code class="language-python">${escapeHtml(content)}</code></pre>`;

  div.appendChild(meta);

  if (data.reply) {
    const reply = document.createElement("div");
    reply.className = "reply-box";
    reply.textContent = data.reply.length > 100 ? data.reply.slice(0, 100) + "..." : data.reply;
    div.appendChild(reply);
  }

  div.appendChild(contentDiv);

  div.addEventListener("click", () => {
    replyTo = data.msg;
    const box = document.getElementById("replyPreview");
    box.textContent = "‚Ü™ " + content.slice(0, 80);
    box.style.display = "block";
  });

  document.getElementById("messages").appendChild(div);
  Prism.highlightAllUnder(div);
  div.scrollIntoView({ behavior: "smooth" }); 
}


function voteOnPoll(pollId, option) {
  const netid = localStorage.getItem("netid") || "unknown";
  socket.emit("vote", { poll_id: pollId, option, netid });
}

// Socket setup
socket.emit("join", { section });


socket.on("message", function(data) {
  if (typeof data === "string") {
    addMessageObject({ msg: data, timestamp: "[old]", netid: "?", edited: false });
  } else {
    addMessageObject(data);
  }
});

function sendMessage() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  const netid = localStorage.getItem("netid") || "unknown";

  if (text) {
    const full = `${netid}: ${text}`;
    const msg = replyTo ? `${full}|||reply|||${replyTo}` : full;
    socket.emit("message", { section, msg });
    input.value = "";
    replyTo = null;
    document.getElementById("replyPreview").style.display = "none";
  }
}

document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("msgInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

window.onload = function () {
  const messagesDiv = document.getElementById("messages");
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
};
</script>
{% endblock %}
