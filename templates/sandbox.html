{% extends "base.html" %}
{% block title %}Python Sandbox{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
<style>
  .sandbox-wrap { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; }
  @media (max-width: 980px){ .sandbox-wrap { grid-template-columns: 1fr; } }
  .panel { border: 1px solid #ccc; border-radius: 10px; padding: 12px; background: var(--bg); color: var(--text); }
  .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem; }
  .toolbar .btn { padding:.45rem .9rem; border-radius:7px; border:1px solid #bbb; background:#eee; cursor:pointer; }
  .toolbar .btn:disabled { opacity:.6; cursor:not-allowed; }

  /* Fit on a laptop viewport without inner scrollbars */
  .CodeMirror { min-height: 50vh; border: 1px solid #ccc; border-radius: 8px; }
  #out { border: 1px dashed #aaa; border-radius: 8px; padding: 8px; height: 58vh; overflow: auto; background: rgba(0,0,0,0.03); }

  .stdout { white-space: pre-wrap; }
  .stderr { white-space: pre-wrap; color: #b00020; }
  .system { font-style: italic; color: gray; }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom:.4rem;">Python Sandbox</h2>

<div class="sandbox-wrap">
  <div class="panel">
    <div class="toolbar">
      <button id="runBtn" class="btn">Run ▶</button>
      <button id="clearBtn" class="btn">Clear</button>
    </div>
    <textarea id="editor"># Write Python below. Define variables or print results.
print("Hello, sandbox!")</textarea>
  </div>

  <div class="panel">
    <h3 style="margin-top:0;">Results</h3>
    <div id="out"><div class="system">Output will appear here.</div></div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script>
(function(){
  function cmTheme(){ return document.documentElement.getAttribute('data-theme') === 'dark' ? 'material' : 'eclipse'; }

  const ta = document.getElementById('editor');
  const editor = CodeMirror.fromTextArea(ta, { mode:'python', theme: cmTheme(), lineNumbers:true, indentUnit:4 });
  new MutationObserver(m=>editor.setOption('theme', cmTheme()))
    .observe(document.documentElement, {attributes:true, attributeFilter:['data-theme']});

  const out = document.getElementById('out');
  const runBtn = document.getElementById('runBtn');
  const clearBtn = document.getElementById('clearBtn');

  function append(kind, text){
    const div = document.createElement('div');
    div.className = kind;
    div.textContent = text;
    out.appendChild(div);
    out.scrollTop = out.scrollHeight;
  }
  function resetOut(msg){ out.innerHTML = ''; if (msg) append('system', msg); }

  clearBtn.addEventListener('click', ()=> resetOut('Cleared.'));

  runBtn.addEventListener('click', async ()=>{
    runBtn.disabled = true;
    resetOut('Running…');
    try {
      const r = await fetch('/api/sandbox/run', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code: editor.getValue() })
      });
      if (!r.ok) {
        const t = await r.text();
        append('stderr', `HTTP ${r.status}: ${t}`);
      } else {
        const data = await r.json();
        if (data.stdout) append('stdout', data.stdout);
        if (data.stderr) append('stderr', data.stderr);
        if (!data.stdout && !data.stderr) append('system', 'No output.');
      }
    } catch (e) {
      append('stderr', String(e));
    } finally {
      runBtn.disabled = false;
    }
  });
})();
</script>
{% endblock %}

