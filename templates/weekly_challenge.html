{% extends "base.html" %}
{% block title %}Weekly Challenge{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
  .wc-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; align-items:start; }
  @media (max-width: 980px){ .wc-wrap { grid-template-columns: 1fr; } }
  .wc-col { min-width: 260px; }
  .CodeMirror { border:1px solid #ccc; border-radius:8px; min-height: 40vh; }
  .panel { border:1px solid #ccc; border-radius:8px; padding:12px; background:var(--bg); color:var(--text); }
  .row { display:flex; gap:.5rem; align-items:center; margin:.75rem 0; flex-wrap:wrap; }
  .muted { color: gray; }
  .btn { padding:.45rem .9rem; border:0; border-radius:7px; cursor:pointer; }
  .btn-primary { background:#2151ff; color:#fff; }
  .btn-ghost { background:#eee; }
  .list { list-style:none; padding-left:1rem; }
  #results .case { border-bottom:1px solid #ddd; padding:.5rem 0; }
  #results .ok { color: #19733b; }
  #results .bad { color: #b00020; }
  pre { background: rgba(0,0,0,0.04); padding:.6rem .8rem; border-radius:8px; overflow:auto; }
  code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .error { border:1px solid #e57373; background:#fdecea; color:#b71c1c; padding:.6rem .8rem; border-radius:8px; }
</style>
{% endblock %}

{% block content %}
<h2>Weekly Challenge</h2>

{% if not session.get("netid") %}
  <div class="error">You’re not logged in. Please log in to view the challenge.</div>
{% else %}
  <div id="loadError" class="error" style="display:none;"></div>

  <div class="row">
    <label for="challengeSelect"><b>Select Challenge:</b></label>
    <select id="challengeSelect"></select>
    <span id="pubBadge" class="muted"></span>
  </div>

  <div id="noChallenge" class="panel" style="display:none;">
    No challenge available for your view. (Admins see unpublished challenges; students only see published/active ones.)
  </div>

  <div id="challengeUI" style="display:none;">
    <div class="wc-wrap">
      <div class="wc-col">
        <div class="panel">
          <h3 id="cTitle" style="margin-top:0;"></h3>
          <div id="cProblem"></div>
          <div id="cExamples" style="margin-top:.5rem;"></div>
        </div>

        <div class="row">
          <button id="runBtn" class="btn btn-ghost" title="Run locally (no submit)">▶ Run</button>
          <button id="submitBtn" class="btn btn-primary" title="Run tests and submit">Submit</button>
          <span id="runStatus" class="muted"></span>
        </div>

        <textarea id="editor">def solution(x):
    # write your solution
    return x
</textarea>
      </div>

      <div class="wc-col">
        <div class="panel">
          <h3 style="margin-top:0;">Results</h3>
          <div id="results" class="muted">Run or submit to see per-test results.</div>
        </div>

        <div class="panel" style="margin-top:1rem;">
          <h3 style="margin-top:0;">Leaderboard</h3>
          <ol id="leaderboard" class="list"></ol>
          <div id="solDate" class="muted"></div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
(function(){
  {% if not session.get("netid") %} return; {% endif %}

  const loadError = document.getElementById('loadError');
  function showLoadError(msg){
    loadError.textContent = msg;
    loadError.style.display = 'block';
  }

  // CodeMirror theme follows site theme
  function cmTheme() {
    return document.documentElement.getAttribute('data-theme') === 'dark' ? 'material' : 'eclipse';
  }
  const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
    mode:'python', theme: cmTheme(), lineNumbers:true, indentUnit:4
  });
  new MutationObserver(muts => muts.forEach(m=>{
    if (m.attributeName === 'data-theme') editor.setOption('theme', cmTheme());
  })).observe(document.documentElement, {attributes:true});

  const sel = document.getElementById('challengeSelect');
  const pubBadge = document.getElementById('pubBadge');
  const noUI = document.getElementById('noChallenge');
  const ui = document.getElementById('challengeUI');
  const cTitle = document.getElementById('cTitle');
  const cProblem = document.getElementById('cProblem');
  const cExamples = document.getElementById('cExamples');
  const resultsDiv = document.getElementById('results');
  const runBtn = document.getElementById('runBtn');
  const submitBtn = document.getElementById('submitBtn');
  const runStatus = document.getElementById('runStatus');
  const leaderboard = document.getElementById('leaderboard');
  const solDate = document.getElementById('solDate');

  function renderProblem(md){
    if (!md) return '';
    const esc = (s)=>s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    md = md.replace(/```(python)?\n([\s\S]*?)```/g, (_,lang,code)=>`<pre><code class="language-${lang||'python'}">${esc(code)}</code></pre>`);
    md = md.replace(/`([^`]+)`/g, (_,code)=>`<code>${esc(code)}</code>`);
    return md.split(/\n\n+/).map(p => p.startsWith('<pre>') ? p : `<p>${p.replace(/\n/g,'<br>')}</p>`).join('\n');
  }
  function hl(){ try{ document.querySelectorAll('pre code').forEach(el => window.hljs && hljs.highlightElement(el)); }catch(e){} }

  async function fetchJSON(url, opts){
    const r = await fetch(url, opts);
    const txt = await r.text();
    if (!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,300)}`);
    try { return JSON.parse(txt); } catch { throw new Error(`Bad JSON: ${txt.slice(0,300)}`); }
  }

  async function loadChallenges() {
    try {
      const data = await fetchJSON('/weekly_challenge/challenges');
      const list = (data && data.challenges) || [];
      sel.innerHTML = '';
      if (!list.length) {
        ui.style.display = 'none'; noUI.style.display = 'block';
        return;
      }
      list.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.textContent = ch.title || (ch.problem ? ch.problem.slice(0,40) : ch.id);
        sel.appendChild(opt);
      });
      sel.selectedIndex = 0;
      await loadOne(sel.value);
    } catch (e) {
      showLoadError('Failed to load challenges: ' + e.message);
      ui.style.display = 'none'; noUI.style.display = 'block';
    }
  }

  async function loadOne(cid) {
    try{
      const ch = await fetchJSON(`/weekly_challenge/challenge/${cid}`);
      cTitle.textContent = ch.title || 'Challenge';
      cProblem.innerHTML = renderProblem(ch.problem || '');
      cExamples.innerHTML = ch.examples ? `<h4>Examples</h4>${renderProblem(ch.examples)}` : '';
      pubBadge.textContent = (ch.published === false) ? '(unpublished)' : '';
      ui.style.display = 'block'; noUI.style.display = 'none';
      resultsDiv.innerHTML = '<span class="muted">Run or submit to see per-test results.</span>';
      runStatus.textContent = '';
      await loadLeaderboard(cid);
      hl();
      currentId = cid;
    } catch(e){
      showLoadError('Failed to load challenge: ' + e.message);
      ui.style.display = 'none'; noUI.style.display = 'block';
    }
  }

  async function loadLeaderboard(cid) {
    leaderboard.innerHTML = '';
    try {
      const data = await fetchJSON(`/weekly_challenge/leaderboard/${cid}`);
      (data.leaderboard || []).forEach(row => {
        const li = document.createElement('li');
        li.textContent = `${row.display_name || row.netid} — ${row.timestamp}`;
        leaderboard.appendChild(li);
      });
      solDate.textContent = data.solutions_available_date ? `Solutions available: ${data.solutions_available_date}` : '';
    } catch (e) {
      solDate.textContent = '';
    }
  }

  function showResults(results){
    if (!results || !results.length){ resultsDiv.innerHTML = '<span class="muted">No results.</span>'; return; }
    const esc = (s)=>String(s??'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    resultsDiv.innerHTML = results.map((r,i)=>`
      <div class="case">
        <div><b>Case ${i+1}:</b> <span class="${r.passed?'ok':'bad'}">${r.passed?'✓ passed':'✗ failed'}</span></div>
        <div><b>input</b>: <code>${esc(JSON.stringify(r.input))}</code></div>
        <div><b>printed</b>: <pre>${esc(r.printed||'')}</pre></div>
        <div><b>return</b>: <code>${esc(r.output)}</code></div>
        <div><b>expected</b>: <code>${esc(r.expected)}</code></div>
      </div>
    `).join('');
  }

  let currentId = null;
  document.getElementById('runBtn').addEventListener('click', async () => {
    if (!currentId) return;
    resultsDiv.innerHTML = '';
    runStatus.textContent = 'Running...';
    try {
      const data = await fetchJSON(`/weekly_challenge/submit/${currentId}`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code: editor.getValue(), keystrokes: [] })
      });
      showResults(data.results);
      runStatus.textContent = data.passed ? 'All tests passed.' : 'Some tests failed.';
      await loadLeaderboard(currentId); hl();
    } catch (e) {
      runStatus.textContent = 'Error: ' + e.message;
    }
  });

  document.getElementById('submitBtn').addEventListener('click', async () => {
    if (!currentId) return;
    runStatus.textContent = 'Submitting...';
    try {
      const data = await fetchJSON(`/weekly_challenge/submit/${currentId}`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code: editor.getValue(), keystrokes: [] })
      });
      showResults(data.results);
      runStatus.textContent = data.passed ? 'Submitted (passed)!' : 'Submitted (with failures).';
      await loadLeaderboard(currentId); hl();
    } catch (e) {
      runStatus.textContent = 'Error: ' + e.message;
    }
  });

  document.getElementById('challengeSelect').addEventListener('change', () => loadOne(sel.value));
  loadChallenges();
})();
</script>
{% endblock %}

