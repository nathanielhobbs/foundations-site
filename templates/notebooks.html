{% extends "base.html" %}
{% block title %}Notebooks{% endblock %}

{% block content %}
<h2>Notebooks</h2>
<div id="nbContainer" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px;"></div>
<div id="nbEmpty" style="display:none;">No notebooks found.</div>
{% endblock %}

{% block extra_scripts %}
<script>
(async function () {
  try {
    // Admin can pass ?section=5 etc.; students ignore
    const res = await fetch(
      window.location.search
        ? '/api/notebooks' + window.location.search
        : '/api/notebooks'
    );
    const data = await res.json();
    const wrap = document.getElementById('nbContainer');
    const empty = document.getElementById('nbEmpty');

    if (!data.success || !data.items || !data.items.length) {
      wrap.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    wrap.innerHTML = '';

    const items = [...data.items].sort((a, b) => {
      const da = a.date ? new Date(a.date).getTime() : 0;
      const db = b.date ? new Date(b.date).getTime() : 0;
      return db - da; // newest first
    });

    items.forEach(it => {
      const card = document.createElement('div');
      card.style.border = '1px solid #ccc';
      card.style.borderRadius = '10px';
      card.style.padding = '12px';
      card.style.background = 'var(--bg)';
      card.style.color = 'var(--text)';
      card.innerHTML = `
        <div style="font-weight:600; margin-bottom:.25rem;">${it.title}</div>
        <div class="muted" style="font-size:.9rem; margin-bottom:.5rem;">
          Updated: ${it.date ? new Date(it.date).toLocaleString() : 'â€”'}
        </div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <a class="btn"
             style="border:1px solid #bbb; border-radius:7px; padding:.35rem .7rem; text-decoration:none;"
             href="https://github.com/${it.github_path}" target="_blank" rel="noopener">
            View on GitHub
          </a>
          <a class="btn nb-dl"
             style="border:1px solid #bbb; border-radius:7px; padding:.35rem .7rem; text-decoration:none; cursor:pointer;"
             href="#"
             data-url="${it.download_url}"
             data-name="${it.filename}">
            Download ${it.ext}
          </a>
        </div>`;
      wrap.appendChild(card);
    });
  } catch (err) {
    console.error('Error loading notebooks', err);
    const wrap = document.getElementById('nbContainer');
    const empty = document.getElementById('nbEmpty');
    wrap.style.display = 'none';
    empty.textContent = 'Error loading notebooks.';
    empty.style.display = 'block';
  }
})();
</script>

<script>
function nbSafeName(s) {
  return (s || 'notebook').replace(/[^A-Za-z0-9._-]+/g, '_');
}

async function downloadFile(url, filename) {
  const res = await fetch(url, { credentials: 'omit' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const blob = await res.blob();

  const disp = res.headers.get('Content-Disposition') || '';
  const m = /filename\*?=(?:UTF-8'')?["']?([^"';\n]+)["']?/i.exec(disp);
  const name = m ? decodeURIComponent(m[1]) : filename;

  const a = document.createElement('a');
  const objectUrl = URL.createObjectURL(blob);
  a.href = objectUrl;
  a.download = name || nbSafeName('download');
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(objectUrl);
}

document.addEventListener('click', async (e) => {
  const a = e.target.closest('a.nb-dl');
  if (!a) return;
  e.preventDefault();
  const url = a.getAttribute('data-url');
  const name = a.getAttribute('data-name') || 'download';
  try {
    await downloadFile(url, name);
  } catch (err) {
    console.warn('Blob download failed, falling back:', err);
    window.location.href = url;
  }
});
</script>
{% endblock %}

